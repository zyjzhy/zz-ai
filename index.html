<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å››å¶è‰AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts for better Chinese typography -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Markdown-it for rendering markdown -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js"></script>
    <!-- Highlight.js for syntax highlighting in code blocks -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <!-- Libraries for file parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
        }
        
        .sidebar-transition {
            transition: width 0.3s ease, padding 0.3s ease, border 0.3s ease;
            overflow: hidden;
        }
        
        .message-animation {
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .typing-dots span {
            animation: typing 1.4s infinite ease-in-out;
            display: inline-block;
            margin: 0 1px;
        }
        
        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        .conversation-dropdown {
            position: absolute;
            right: 0.5rem;
            top: 100%;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            z-index: 10;
            min-width: 120px;
            padding: 0.25rem 0;
        }
        
        .conversation-dropdown button {
            width: 100%;
            text-align: left;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            color: #374151;
            display: flex;
            align-items: center;
        }
        
        .conversation-dropdown button:hover {
            background-color: #f3f4f6;
        }
        
        /* === Dark Mode Optimization === */
        .dark-mode { background-color: #111827; color: #f9fafb; }
        .dark-mode .bg-white { background-color: #1f2937; } /* Input backgrounds etc */
        .dark-mode .bg-gray-50 { background-color: #1f2937; }
        .dark-mode .text-gray-800 { color: #f9fafb; }
        .dark-mode .text-gray-700 { color: #e5e7eb; }
        .dark-mode .text-gray-600 { color: #d1d5db; }
        .dark-mode .text-gray-500 { color: #9ca3af; }
        .dark-mode .border-gray-200, .dark-mode .border-gray-300 { border-color: #4b5563; }
        .dark-mode .bg-gray-100 { background-color: #374151; }
        .dark-mode .bg-blue-100 { background-color: #1e3a8a; }
        .dark-mode .hover\:bg-gray-100:hover { background-color: #4b5563; }
        .dark-mode .conversation-dropdown { background: #374151; border-color: #4b5563; }
        .dark-mode .conversation-dropdown button { color: #f9fafb; }
        .dark-mode .conversation-dropdown button:hover { background-color: #4b5563; }
        .dark-mode .prompt-card:hover { background-color: #374151; }
        .dark-mode input[type=range]::-webkit-slider-thumb { background: #60a5fa; }
        .dark-mode input[type=range]::-moz-range-thumb { background: #60a5fa; }
        
        /* Font Size Classes */
        html.font-small { font-size: 14px; }
        html.font-medium { font-size: 16px; }
        html.font-large { font-size: 18px; }

        /* Scrollbar Hiding */
        #chatMessages::-webkit-scrollbar { display: none; }
        #chatMessages { -ms-overflow-style: none; scrollbar-width: none; }

        /* File Drag Overlay */
        #drag-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(99, 102, 241, 0.2); /* indigo-300/20 */
            border: 2px dashed #4f46e5; /* indigo-600 */
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            z-index: 999;
        }
        #drag-overlay.visible { opacity: 1; }
        
        /* Attachment List Optimization */
        #fileUploadListContainer {
            overflow-x: auto;
            padding-bottom: 8px; /* Space for scrollbar */
        }
        #fileList {
            display: flex;
            flex-wrap: nowrap; /* Ensure single line for scrolling */
            gap: 8px;
        }

        /* Chat Area Optimization - ä¿®å¤é—®é¢˜2ï¼šèŠå¤©åŒºåŸŸå®½åº¦ä¸º80% */
        #chatMessages {
            padding: 0.75rem 0.5rem;
            width: 80%;
            margin: 0 auto;
        }

        /* ä¿®å¤é—®é¢˜1ï¼šæ·±è‰²æ¨¡å¼èŠå¤©åŒºåŸŸèƒŒæ™¯ */
        .dark-mode #chatMessages {
            background-color: #111827;
        }
        .dark-mode #chatContainer {
            background-color: #111827;
        }
        
        /* ä¿®å¤é—®é¢˜1ï¼šè®¾ç½®å¼¹çª—å’Œä¾§è¾¹æ é¢œè‰²å¯¹æ¯” */
        .dark-mode .bg-gray-800 {
            background-color: #1f2937;
        }
        .dark-mode .bg-gray-700 {
            background-color: #374151;
        }
        .dark-mode .border-gray-700 {
            border-color: #4b5563;
        }
        
        /* ä¿®å¤é—®é¢˜1ï¼šèŠå¤©æ ‡é¢˜å’Œè¾“å…¥æ¡†èƒŒæ™¯é¢œè‰² */
        .dark-mode #chatHeader {
            background-color: #1f2937;
            border-bottom-color: #374151;
        }
        .dark-mode #inputSection {
            background-color: #1f2937;
            border-top-color: #374151;
        }

        /* ä¿®å¤é—®é¢˜3ï¼šç¼©å°èŠå¤©æ ‡é¢˜å­—ä½“ */
        #chatTitle {
            font-size: 1.125rem; /* ä»åŸæ¥çš„text-xl(1.25rem)å‡å°åˆ°text-lg(1.125rem) */
        }

        /* Markdown and Code Block Styles */
        .markdown-content { 
            overflow-wrap: break-word; 
            word-wrap: break-word; 
            font-size: 0.9rem;
            line-height: 1.4;
        }
        .markdown-content p { margin-bottom: 0.75rem; }
        .markdown-content h1, .markdown-content h2, .markdown-content h3 { 
            margin-top: 1rem; 
            margin-bottom: 0.75rem; 
            font-weight: 600; 
        }
        .markdown-content ul, .markdown-content ol { margin-left: 1.25rem; margin-bottom: 0.75rem; }
        .markdown-content li { margin-bottom: 0.2rem; }
        .markdown-content code:not([class*="language-"]) { 
            background-color: #e5e7eb; 
            color: #1f2937; 
            padding: 0.125rem 0.25rem; 
            border-radius: 0.25rem; 
            font-family: monospace; 
            font-size: 0.85rem;
        }
        .dark-mode .markdown-content code:not([class*="language-"]) { background-color: #4b5563; color: #f9fafb; }
        
        .markdown-content pre {
            position: relative;
            margin-bottom: 0.75rem;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 400px;
            overflow: auto;
            background-color: #1f2937;
            border-radius: 0.5rem;
            padding: 0.75rem;
            font-size: 0.85rem;
        }
        .dark-mode .markdown-content pre { background-color: #1e293b; }

        .markdown-content table { 
            border-collapse: collapse; 
            width: 100%; 
            margin-bottom: 0.75rem; 
            font-size: 0.85rem;
        }
        .markdown-content th, .markdown-content td { border: 1px solid #d1d5db; padding: 0.375rem; }
        .dark-mode .markdown-content th, .dark-mode .markdown-content td { border-color: #4b5563; }
        .markdown-content th { background-color: #f3f4f6; }
        .dark-mode .markdown-content th { background-color: #374151; }
        
        .markdown-content .generated-image { 
            max-width: 350px; 
            max-height: 350px;
            width: auto;
            height: auto;
            border-radius: 0.5rem; 
            margin-top: 0.5rem; 
            object-fit: contain;
        }

        .copy-code-button {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: #4b5563;
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border-radius: 0.25rem;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .markdown-content pre:hover .copy-code-button {
            opacity: 1;
        }
        
        .message-bubble {
            word-break: break-word;
            max-width: 85%;
        }
        
        .action-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 2rem;
            height: 2rem;
            border-radius: 0.375rem;
            color: #6b7280;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .action-btn:hover {
            background-color: #e5e7eb;
            color: #374151;
        }

        .action-btn.delete-btn:hover {
            background-color: #fee2e2; /* red-100 */
            color: #dc2626; /* red-600 */
        }
        
        .dark-mode .action-btn { color: #9ca3af; }
        .dark-mode .action-btn:hover { background-color: #4b5563; color: #d1d5db; }
        .dark-mode .action-btn.delete-btn:hover {
            background-color: #450a0a; /* red-900/50 */
            color: #f87171; /* red-400 */
        }
        
        .action-btn .btn-text {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            white-space: nowrap;
            background-color: #374151;
            color: white;
            text-align: center;
            border-radius: 0.25rem;
            padding: 4px 8px;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            transition: opacity 0.2s ease;
            font-size: 0.75rem;
        }
        
        .dark-mode .action-btn .btn-text { background-color: #111827; }

        .action-btn:hover .btn-text { visibility: visible; opacity: 1; }
        
        .tab-button {
            padding: 0.5rem 1rem;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .tab-button.active { border-bottom-color: #3b82f6; color: #3b82f6; }
        .dark-mode .tab-button.active { color: #60a5fa; border-bottom-color: #60a5fa; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Styles for Thinking Process */
        .thinking-details { margin-bottom: 0.75rem; }
        .thinking-details summary { 
            cursor: pointer; 
            font-weight: 500; 
            color: #6b7280; 
            margin-bottom: 0.5rem; 
            user-select: none; 
            list-style-position: inside; 
            font-size: 0.85rem;
        }
        .dark-mode .thinking-details summary { color: #9ca3af; }
        .thinking-content { 
            background-color: rgba(243, 244, 246, 0.5); 
            border-left: 3px solid #d1d5db; 
            padding: 0.5rem 0.75rem; 
            font-size: 0.8rem; 
            color: #4b5563; 
            border-radius: 0 0.25rem 0.25rem 0;
            max-height: 250px;
            overflow-y: auto;
            line-height: 1.3;
        }
        .dark-mode .thinking-content {
            background-color: rgba(55, 65, 81, 0.5);
            border-left-color: #6b7280;
            color: #d1d5db;
        }

        /* Thinking Animation */
        .thinking-animation {
            display: flex;
            align-items: center;
            padding: 0.5rem 0;
            font-size: 0.85rem;
            color: #6b7280;
        }

        .thinking-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #6b7280;
            margin: 0 2px;
            animation: thinkingPulse 1.5s infinite ease-in-out;
        }

        .thinking-dot:nth-child(1) { animation-delay: -0.32s; }
        .thinking-dot:nth-child(2) { animation-delay: -0.16s; }
        .thinking-dot:nth-child(3) { animation-delay: 0s; }

        @keyframes thinkingPulse {
            0%, 80%, 100% { 
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% { 
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Message Delete Confirmation Modal */
        #messageDeleteConfirmModal {
            z-index: 60;
        }
        
        /* ä¿®å¤é—®é¢˜4ï¼š/imagine å‘½ä»¤æ ·å¼ */
        .imagine-command {
            display: inline-block;
            background-color: #e0f2fe;
            color: #0369a1;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
            margin-right: 4px;
            user-select: none;
        }
        .dark-mode .imagine-command {
            background-color: #0c4a6e;
            color: #bae6fd;
        }

        /* æ–°å¢ï¼šä¼˜åŒ–ç¤ºä¾‹å†…å®¹å®½åº¦ */
        #promptSuggestions {
            max-width: 700px; /* é™åˆ¶æœ€å¤§å®½åº¦ */
            width: 100%;
        }
        
        /* å››å¶è‰å›¾æ ‡æ ·å¼ */
        .clover-icon {
            background-image: url('https://youke1.picui.cn/s1/2025/10/03/68dfc64660214.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        
        /* å››å¶è‰ä¸»é¢˜èƒŒæ™¯é¢œè‰² */
        .clover-bg {
            background-color: #e8f8f3; /* ä¸å››å¶è‰ä¸»é¢˜åŒ¹é… */
        }
        
        .clover-bg-light {
            background-color: #d1fae5; /* æµ…ç»¿è‰² */
        }
        
        .dark-mode .clover-bg {
            background-color: #065f46; /* æ·±ç»¿è‰² */
        }
        
        .dark-mode .clover-bg-light {
            background-color: #064e3b; /* æ·±ç»¿è‰² */
        }

        /* ä¾§è¾¹æ é¡¶éƒ¨å›¾æ ‡ - æ”¾å¤§ */
        #sidebar .p-4 .clover-icon {
            width: 36px !important;  /* ä»åŸæ¥çš„20pxæ”¾å¤§åˆ°24px */
            height: 36px !important;
        }

        /* ä¾§è¾¹æ åˆ‡æ¢æŒ‰é’®ä¸­çš„å›¾æ ‡ - æ”¾å¤§ */
        #sidebarToggleContainer .clover-icon {
            width: 36px !important;  /* ä»åŸæ¥çš„16pxæ”¾å¤§åˆ°20px */
            height: 36px !important;
        }

        /* æ¬¢è¿åŒºåŸŸå¤§å›¾æ ‡ - æ”¾å¤§ */
        #welcomeSection .clover-icon {
            width: 64px !important;  /* ä»åŸæ¥çš„32pxæ”¾å¤§åˆ°48px */
            height: 64px !important;
        }

        /* èŠå¤©æ¶ˆæ¯ä¸­çš„AIå›¾æ ‡ - æ”¾å¤§ */
        .chat-message-ai .clover-icon {
            width: 36px !important;  /* ä»åŸæ¥çš„16pxæ”¾å¤§åˆ°20px */
            height: 36px !important;
        }

        /* æ‰“å­—æŒ‡ç¤ºå™¨ä¸­çš„å›¾æ ‡ - æ”¾å¤§ */
        #typingIndicator .clover-icon {
            width: 20px !important;  /* ä»åŸæ¥çš„16pxæ”¾å¤§åˆ°20px */
            height: 20px !important;
        }
                
        /* æ–‡ä»¶å†…å®¹æ˜¾ç¤ºåŒºåŸŸ */
        .file-content-display {
            background-color: #f3f4f6;
            border-left: 4px solid #10b981;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.85rem;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .dark-mode .file-content-display {
            background-color: #374151;
            border-left-color: #34d399;
        }
        
        .file-content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .file-error {
            border-left-color: #ef4444;
            background-color: #fef2f2;
        }
        
        .dark-mode .file-error {
            background-color: #450a0a;
            border-left-color: #f87171;
        }

        /* ä¿®æ”¹ç”¨æˆ·æ¶ˆæ¯æ¡†èƒŒæ™¯é¢œè‰²ä¸º rgb(100 199 115) */
        .bg-blue-500 {
            background-color: rgb(100 199 115) !important;
        }

        .dark-mode .bg-blue-500 {
            background-color: rgb(80 179 95) !important;
        }

        /* ç¡®ä¿ä»£ç å—æ ·å¼æ­£ç¡®ï¼Œé¿å…é‡å¤èƒŒæ™¯ */
        .markdown-content pre {
            background-color: #1f2937 !important;
            padding: 0.75rem !important;
            border-radius: 0.5rem !important;
            margin-bottom: 0.75rem !important;
            position: relative;
        }

        .dark-mode .markdown-content pre {
            background-color: #1e293b !important;
        }

        /* ç§»é™¤å¯èƒ½é‡å¤çš„preæ ·å¼ */
        .markdown-content pre pre {
            background-color: transparent !important;
            padding: 0 !important;
            margin: 0 !important;
        }

        /* é™åˆ¶èŠå¤©åŒºåŸŸæ•´ä½“å®½åº¦ */
    .chat-header-container, .chat-container-wrapper, .input-section-wrapper {
        width: 100%;
        max-width: 800px;
        margin: 0 auto;
    }

    </style>
</head>
<body class="bg-gray-50 h-screen flex overflow-hidden dark:bg-gray-900">
    <!-- Sidebar Toggle Button (when hidden) -->
    <div id="sidebarToggleContainer" class="absolute top-4 left-4 z-20 hidden">
        <div class="bg-white rounded-lg shadow-sm p-2 flex items-center space-x-2 dark:bg-gray-700">
            <div class="w-7 h-7 clover-bg rounded-full flex items-center justify-center">
                <div class="clover-icon w-4 h-4"></div>
            </div>
            <button id="sidebarToggleBtn" class="text-gray-600 hover:text-gray-900 dark:text-gray-300 dark:hover:text-white px-2">
                <i class="fas fa-bars"></i>
            </button>
            <button id="newChatBtnTop" class="text-gray-600 hover:text-gray-900 dark:text-gray-300 dark:hover:text-white px-2">
                <i class="fas fa-plus"></i>
            </button>
        </div>
    </div>
    
    <!-- Sidebar -->
    <div id="sidebar" class="w-64 bg-white border-r border-gray-200 flex flex-col sidebar-transition h-full dark:bg-gray-800 dark:border-gray-700">
        <div class="p-4 border-b border-gray-200 flex items-center justify-between flex-shrink-0 dark:border-gray-700">
            <div class="flex items-center space-x-2">
                <div class="w-8 h-8 clover-bg rounded-full flex items-center justify-center">
                    <div class="clover-icon w-5 h-5"></div>
                </div>
                <span class="font-semibold text-gray-800 dark:text-gray-200">å››å¶è‰AI</span>
            </div>
            <button id="closeSidebarBtn" class="text-gray-600 hover:text-gray-900 dark:text-gray-300 dark:hover:text-white">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="p-4 flex-shrink-0">
            <button id="newChatBtn" class="w-full py-2 px-4 bg-white rounded-lg shadow-sm text-gray-700 hover:bg-gray-100 transition-colors flex items-center justify-center dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600">
                <i class="fas fa-plus mr-2"></i>
                å¼€å¯æ–°å¯¹è¯
            </button>
        </div>
        
        <div class="flex-1 overflow-y-auto">
            <div id="historyList" class="p-2 space-y-1"></div>
        </div>
        
        <div class="p-4 border-t border-gray-200 flex-shrink-0 dark:border-gray-700">
            <button id="pageSettingsBtn" class="w-full py-2 px-4 bg-white rounded-lg shadow-sm text-gray-700 hover:bg-gray-100 transition-colors flex items-center justify-center dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600">
                <i class="fas fa-cog mr-2"></i>
                é¡µé¢è®¾ç½®
            </button>
        </div>
    </div>

    <!-- Main Content Area -->
    <div id="mainContentArea" class="flex-1 flex flex-col relative">
        <!-- File Drag Overlay -->
        <div id="drag-overlay">
            <div class="text-center text-indigo-600 font-semibold">
                <i class="fas fa-upload fa-2x"></i>
                <p class="mt-2">æ¾å¼€å³å¯ä¸Šä¼ æ–‡ä»¶</p>
            </div>
        </div>
        
        <!-- Chat Header -->
        <header id="chatHeader" class="p-4 border-b border-gray-200 hidden dark:border-gray-700">
            <h1 id="chatTitle" class="text-lg font-bold text-gray-800 text-center dark:text-gray-200">å››å¶è‰AI</h1>
        </header>

        <!-- Chat Area -->
        <div class="flex-1 overflow-y-auto" id="chatContainer">
            <div id="chatMessages" class="p-4 space-y-6 w-full max-w-4xl mx-auto"></div>
        </div>

        <!-- Welcome & Input Container (Initially centered) -->
        <div id="welcomeAndInputContainer" class="flex-1 flex flex-col items-center justify-center p-4 pb-8">
            <div class="w-full max-w-4xl flex flex-col items-center">
                 <!-- Welcome Message -->
                <div id="welcomeSection" class="text-center mb-8">
                    <div class="w-16 h-16 clover-bg rounded-full flex items-center justify-center mx-auto mb-4">
                        <div class="clover-icon w-8 h-8"></div>
                    </div>
                    <h2 class="text-2xl font-medium text-gray-800 dark:text-gray-200">æ„¿ä»Šå¤©ğŸ€èƒ½å¸®åŠ©åˆ°æ‚¨ï¼Ÿ</h2>
                </div>
                
                <!-- Prompt Suggestions -->
                <div id="promptSuggestions" class="w-full grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="prompt-card bg-white dark:bg-gray-700 p-4 rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors" data-prompt-text="å¸®æˆ‘å†™ä¸€å°å…³äºäº§å“å»¶æœŸå‘å¸ƒçš„é“æ­‰é‚®ä»¶">
                        <p class="font-semibold text-gray-800 dark:text-gray-200">å†™ä¸€å°é‚®ä»¶</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">å…³äºäº§å“å»¶æœŸå‘å¸ƒçš„é“æ­‰ä¿¡</p>
                    </div>
                    <div class="prompt-card bg-white dark:bg-gray-700 p-4 rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors" data-prompt-text="ç”¨è¡¨æ ¼å½¢å¼æ€»ç»“ä¸€ä¸‹äººå·¥æ™ºèƒ½ã€æœºå™¨å­¦ä¹ å’Œæ·±åº¦å­¦ä¹ çš„åŒºåˆ«">
                        <p class="font-semibold text-gray-800 dark:text-gray-200">ç”¨è¡¨æ ¼æ€»ç»“</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">AIã€æœºå™¨å­¦ä¹ å’Œæ·±åº¦å­¦ä¹ çš„åŒºåˆ«</p>
                    </div>
                    <div class="prompt-card bg-white dark:bg-gray-700 p-4 rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors" data-prompt-text="ç”¨Pythonå†™ä¸€ä¸ªå¿«é€Ÿæ’åºç®—æ³•">
                         <p class="font-semibold text-gray-800 dark:text-gray-200">å†™ä¸€ä¸ªç®—æ³•</p>
                         <p class="text-sm text-gray-500 dark:text-gray-400">ä½¿ç”¨ Python å®ç°å¿«é€Ÿæ’åº</p>
                    </div>
                    <div class="prompt-card bg-white dark:bg-gray-700 p-4 rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors" data-prompt-type="image" data-prompt-text="ä¸€åªåœ¨èµ›åšæœ‹å…‹åŸå¸‚é›¨å¤œä¸­æ¼«æ­¥çš„çŒ«ï¼Œéœ“è™¹ç¯å…‰åå°„åœ¨æ¹¿æ¼‰æ¼‰çš„è¡—é“ä¸Š">
                        <p class="font-semibold text-gray-800 dark:text-gray-200">å›¾ç‰‡ç”Ÿæˆ</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">ä¸€åªåœ¨èµ›åšæœ‹å…‹é›¨å¤œæ¼«æ­¥çš„çŒ«</p>
                    </div>
                </div>

                <!-- Input section will be moved here by JS -->
                <div id="inputSectionContainer" class="w-full"></div>
            </div>
        </div>
        
        <!-- This is the actual input box HTML, which will be moved by JS -->
        <div id="inputSection" class="w-full">
            <div class="max-w-4xl mx-auto w-full">
                <!-- ä¿®å¤é—®é¢˜2ï¼šæ–‡ä»¶å†…å®¹æ˜¾ç¤ºåŒºåŸŸ -->
                <div id="fileContentDisplay" class="mb-3 hidden">
                    <div class="file-content-display">
                        <div class="file-content-header">
                            <span>å·²ä¸Šä¼ æ–‡ä»¶å†…å®¹ï¼š</span>
                            <button id="clearFileContentBtn" class="text-xs text-red-500 hover:text-red-700">æ¸…é™¤</button>
                        </div>
                        <div id="fileContentText" class="text-sm"></div>
                    </div>
                </div>
                
                <!-- Uploaded File List -->
                <div id="fileUploadListContainer" class="mb-2 hidden">
                    <div id="fileList"></div>
                </div>

                <!-- Input Box -->
                <div class="relative bg-white border border-gray-300 rounded-lg shadow-sm dark:bg-gray-800 dark:border-gray-600">
                    <div id="messageInputContainer" class="relative">
                        <textarea 
                            id="messageInput" 
                            placeholder="ç»™ å››å¶è‰AI å‘é€æ¶ˆæ¯ï¼Œæˆ–å°†æ–‡ä»¶æ‹–æ‹½åˆ°è¿™é‡Œ"
                            class="w-full p-4 pr-20 pb-12 border-0 rounded-lg focus:outline-none resize-none bg-transparent dark:text-gray-200 dark:placeholder-gray-400"
                            style="min-height: 64px; box-sizing: border-box;"
                        ></textarea>
                        <!-- /imagine å‘½ä»¤æ˜¾ç¤ºåŒºåŸŸ -->
                        <div id="imagineCommandDisplay" class="absolute top-4 left-4 hidden">
                            <span class="imagine-command">/imagine</span>
                        </div>
                    </div>
                     <!-- Character Count -->
                    <div id="charCount" class="absolute bottom-3 right-20 text-xs text-gray-400">0/128000</div>
                    
                    <!-- Bottom Toolbar -->
                    <div class="absolute bottom-3 left-3 right-3 flex items-center justify-between">
                        <div class="flex items-center space-x-1">
                            <button id="modelSelectBtn" class="px-3 py-1.5 text-sm text-gray-600 hover:bg-gray-100 rounded-md flex items-center transition-colors dark:text-gray-300 dark:hover:bg-gray-700">
                                <i class="fas fa-brain mr-1.5"></i>
                                <span id="currentModelName"></span>
                            </button>
                            
                            <button id="attachFileBtn" class="w-8 h-8 text-gray-500 hover:bg-gray-100 rounded-md flex items-center justify-center transition-colors dark:text-gray-400 dark:hover:bg-gray-700" title="ä¸Šä¼ æ–‡ä»¶">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            
                            <button id="imageGenBtn" class="w-8 h-8 text-gray-500 hover:bg-gray-100 rounded-md flex items-center justify-center transition-colors dark:text-gray-400 dark:hover:bg-gray-700" title="å›¾ç‰‡ç”Ÿæˆ">
                                <i class="fas fa-image"></i>
                            </button>
                        </div>
                        
                        <button id="sendMessageBtn" class="w-9 h-9 bg-blue-500 text-white rounded-lg flex items-center justify-center hover:bg-blue-600 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed" title="å‘é€">
                            <i id="sendBtnIcon" class="fas fa-arrow-up"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals Section -->
    <!-- Model Settings Modal -->
    <div id="modelSettingsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl dark:bg-gray-800">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold dark:text-gray-200">æ¨¡å‹è®¾ç½®</h3>
                <button id="closeModelSettingsModal" class="text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            
            <!-- Tab Navigation -->
            <div class="border-b border-gray-200 dark:border-gray-600 mb-4">
                <div class="flex -mb-px">
                    <button class="tab-button active dark:text-gray-400" data-tab="chat">å¯¹è¯æ¨¡å‹</button>
                    <button class="tab-button dark:text-gray-400" data-tab="image">å›¾åƒæ¨¡å‹</button>
                </div>
            </div>
            
            <!-- Chat Model Tab -->
            <div class="tab-content active" id="chat-tab">
                <div class="space-y-6">
                    <!-- Model Selection -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">å¯¹è¯æ¨¡å‹</label>
                        <select id="chatModelSelect" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"></select>
                    </div>

                    <!-- Advanced Parameters -->
                    <div>
                        <h4 class="text-md font-medium text-gray-800 dark:text-gray-200 mb-3 border-b pb-2 dark:border-gray-600">é«˜çº§å‚æ•°</h4>
                        <div class="space-y-4">
                            <!-- Temperature -->
                            <div>
                                <div class="flex justify-between items-center">
                                    <label for="temperatureSlider" class="block text-sm font-medium text-gray-700 dark:text-gray-300">éšæœºæ€§ (Temperature)</label>
                                    <span id="temperatureValue" class="text-sm font-mono text-blue-600 dark:text-blue-400">0.70</span>
                                </div>
                                <input id="temperatureSlider" type="range" min="0" max="1" step="0.01" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-600">
                            </div>
                            <!-- Max Tokens -->
                             <div>
                                <label for="maxTokensInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300">æœ€å¤§è¾“å‡º (Max Tokens)</label>
                                <input type="number" id="maxTokensInput" min="1" max="4096" class="mt-1 w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            </div>
                            <!-- Context Rounds -->
                            <div>
                                <div class="flex justify-between items-center">
                                    <label for="contextRoundsSlider" class="block text-sm font-medium text-gray-700 dark:text-gray-300">ä¸Šä¸‹æ–‡è½®æ¬¡</label>
                                    <span id="contextRoundsValue" class="text-sm font-mono text-blue-600 dark:text-blue-400">10</span>
                                </div>
                                <input id="contextRoundsSlider" type="range" min="1" max="20" step="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-600">
                            </div>
                            <!-- Max Context Length Info -->
                            <div class="text-sm text-gray-500 dark:text-gray-400">
                                å½“å‰æ¨¡å‹æœ€å¤§ä¸Šä¸‹æ–‡é•¿åº¦ï¼š<span id="maxContextLength" class="font-semibold"></span> Tokens
                            </div>
                        </div>
                    </div>

                    <!-- Other Settings -->
                    <div>
                        <label for="streamToggle" class="flex items-center cursor-pointer">
                            <input type="checkbox" id="streamToggle" class="form-checkbox h-5 w-5 text-blue-600 rounded focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:checked:bg-blue-600">
                            <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">æµå¼è¾“å‡º</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Image Model Tab -->
            <div class="tab-content" id="image-tab">
                <div class="space-y-6">
                    <!-- Model Selection -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">å›¾åƒæ¨¡å‹</label>
                        <select id="imageModelSelect" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"></select>
                    </div>
                    
                    <!-- Image Size Selection -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">å›¾ç‰‡å°ºå¯¸</label>
                        <select id="imageSizeSelect" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <option value="1024x1024">1024x1024 (1:1)</option>
                            <option value="960x1280">960x1280 (3:4)</option>
                            <option value="768x1024">768x1024 (3:4)</option>
                            <option value="720x1440">720x1440 (1:2)</option>
                            <option value="720x1280">720x1280 (9:16)</option>
                        </select>
                    </div>
                    
                    <!-- Advanced Parameters -->
                    <div>
                        <h4 class="text-md font-medium text-gray-800 dark:text-gray-200 mb-3 border-b pb-2 dark:border-gray-600">é«˜çº§å‚æ•°</h4>
                        <div class="space-y-4">
                            <!-- Guidance Scale -->
                            <div>
                                <div class="flex justify-between items-center">
                                    <label for="guidanceScaleSlider" class="block text-sm font-medium text-gray-700 dark:text-gray-300">å¼•å¯¼å¼ºåº¦ (Guidance Scale)</label>
                                    <span id="guidanceScaleValue" class="text-sm font-mono text-blue-600 dark:text-blue-400">7.5</span>
                                </div>
                                <input id="guidanceScaleSlider" type="range" min="1" max="20" step="0.1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-600">
                            </div>
                            
                            <!-- Inference Steps -->
                            <div>
                                <div class="flex justify-between items-center">
                                    <label for="inferenceStepsSlider" class="block text-sm font-medium text-gray-700 dark:text-gray-300">æ¨ç†æ­¥æ•° (Inference Steps)</label>
                                    <span id="inferenceStepsValue" class="text-sm font-mono text-blue-600 dark:text-blue-400">20</span>
                                </div>
                                <input id="inferenceStepsSlider" type="range" min="1" max="50" step="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-600">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 mt-8">
                <button id="saveModelSettingsBtn" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">ç¡®å®š</button>
            </div>
        </div>
    </div>
    <!-- File Upload Modal -->
    <div id="fileUploadModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-96 dark:bg-gray-800">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium dark:text-gray-200">ä¸Šä¼ æ–‡ä»¶</h3>
                <button id="closeFileUploadModal" class="text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="mb-4">
                <div id="fileDropArea" class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-8 text-center cursor-pointer hover:border-blue-500 transition-colors">
                    <i class="fas fa-cloud-upload-alt text-gray-400 text-4xl mb-4"></i>
                    <p class="text-gray-600 dark:text-gray-300">æ‹–æ”¾æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»ä¸Šä¼ </p>
                    <p class="text-gray-400 text-sm mt-2">æ”¯æŒ Excel, TXT, PDF, Word æ–‡ä»¶</p>
                    <input type="file" id="fileInput" class="hidden" multiple accept=".xlsx,.xls,.txt,.pdf,.doc,.docx">
                </div>
            </div>
        </div>
    </div>
    <!-- Page Settings Modal -->
    <div id="pageSettingsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-96 dark:bg-gray-800">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium dark:text-gray-200">é¡µé¢è®¾ç½®</h3>
                <button id="closePageSettingsModal" class="text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ä¸»é¢˜è®¾ç½®</label>
                <select id="themeSelect" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    <option value="light">æµ…è‰²æ¨¡å¼</option>
                    <option value="dark">æ·±è‰²æ¨¡å¼</option>
                    <option value="auto">è·Ÿéšç³»ç»Ÿ</option>
                </select>
            </div>
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">å­—ä½“å¤§å°</label>
                <select id="fontSizeSelect" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    <option value="small">å°</option>
                    <option value="medium" selected>ä¸­</option>
                    <option value="large">å¤§</option>
                </select>
            </div>
            <div class="flex justify-end space-x-3">
                <button id="savePageSettingsBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">ä¿å­˜</button>
            </div>
        </div>
    </div>
    <!-- Rename Conversation Modal -->
    <div id="renameConversationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-96 dark:bg-gray-800">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium dark:text-gray-200">é‡å‘½åå¯¹è¯</h3>
                <button id="closeRenameModal" class="text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="mb-4">
                <input type="text" id="renameInput" placeholder="è¾“å…¥æ–°æ ‡é¢˜" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"/>
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancelRenameBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500">å–æ¶ˆ</button>
                <button id="saveRenameBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">ä¿å­˜</button>
            </div>
        </div>
    </div>
    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-96 dark:bg-gray-800">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-red-600 dark:text-red-500">æ°¸ä¹…åˆ é™¤å¯¹è¯</h3>
                <button id="closeDeleteModal" class="text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="mb-6">
                <p class="text-gray-700 dark:text-gray-300">åˆ é™¤åï¼Œè¯¥å¯¹è¯å°†ä¸å¯æ¢å¤ã€‚ç¡®è®¤åˆ é™¤å—ï¼Ÿ</p>
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancelDeleteBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500">å–æ¶ˆ</button>
                <button id="confirmDeleteBtn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">ç¡®å®š</button>
            </div>
        </div>
    </div>
    <!-- Message Delete Confirmation Modal -->
    <div id="messageDeleteConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-96 dark:bg-gray-800">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-red-600 dark:text-red-500">åˆ é™¤æ¶ˆæ¯</h3>
                <button id="closeMessageDeleteModal" class="text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="mb-6">
                <p class="text-gray-700 dark:text-gray-300">ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚</p>
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancelMessageDeleteBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500">å–æ¶ˆ</button>
                <button id="confirmMessageDeleteBtn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">ç¡®å®š</button>
            </div>
        </div>
    </div>
    
    <script>
        // --- Model Configuration ---
        const MODELS_CONFIG = {
            chat: [
                // Models that SUPPORT thinking mode
                { id: 'deepseek-ai/DeepSeek-R1-Distill-Qwen-7B', name: 'DeepSeek-R1-Distill', maxContext: 128000, supportsThinking: true },
                { id: 'THUDM/glm-4-9b-chat', name: 'GLM-4-9B-Chat', maxContext: 128000, supportsThinking: true },
                
                { id: 'Qwen/Qwen2-7B-Instruct', name: 'Qwen2-7B-Instruct', maxContext: 32000, supportsThinking: true },
                { id: 'Qwen/Qwen2.5-7B-Instruct', name: 'Qwen2.5-7B-Instruct', maxContext: 32000, supportsThinking: true },
                { id: 'Qwen/Qwen3-8B', name: 'Qwen3-8B', maxContext: 128000, supportsThinking: true },
                
                // Models that DO NOT support thinking mode
                { id: 'Qwen/Qwen2.5-Coder-7B-Instruct', name: 'Qwen2.5-Coder-7B-Instruct', maxContext: 32000, supportsThinking: false },
                { id: 'deepseek-ai/DeepSeek-R1-0528-Qwen3-8B', name: 'DeepSeek-R1-0528', maxContext: 128000, supportsThinking: false },
                { id: 'THUDM/GLM-Z1-9B-0414', name: 'GLM-Z1-9B-0414', maxContext: 128000, supportsThinking: false },
                { id: 'THUDM/GLM-4.1V-9B-Thinking', name: 'GLM-4.1V-9B-Thinking', maxContext: 64000, supportsThinking: false },
                { id: 'internlm/internlm2_5-7b-chat', name: 'InternLM2.5-7B-Chat', maxContext: 32000, supportsThinking: false },
            ],
            image: [
                { id: 'Kwai-Kolors/Kolors', name: 'Kwai Kolors' }
            ]
        }

        const DEFAULT_SETTINGS = {
            chat: {
                modelId: 'Qwen/Qwen3-8B',
                temperature: 0.7,
                maxTokens: 4096, // ç¡®ä¿ä¸è¶…è¿‡4096
                contextRounds: 10,
                stream: true,
            },
            image: {
                modelId: 'Kwai-Kolors/Kolors',
                size: '1024x1024',
                guidanceScale: 7.5,
                inferenceSteps: 20,
            }
        };

        // DOM Elements
        const sidebar = document.getElementById('sidebar');
        const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
        const sidebarToggleContainer = document.getElementById('sidebarToggleContainer');
        const closeSidebarBtn = document.getElementById('closeSidebarBtn');
        const chatMessages = document.getElementById('chatMessages');
        const chatHeader = document.getElementById('chatHeader');
        const chatTitle = document.getElementById('chatTitle');
        const messageInput = document.getElementById('messageInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const sendBtnIcon = document.getElementById('sendBtnIcon');
        const newChatBtn = document.getElementById('newChatBtn');
        const newChatBtnTop = document.getElementById('newChatBtnTop');
        const historyList = document.getElementById('historyList');
        const welcomeAndInputContainer = document.getElementById('welcomeAndInputContainer');
        const inputSection = document.getElementById('inputSection');
        const inputSectionContainer = document.getElementById('inputSectionContainer');
        const chatContainer = document.getElementById('chatContainer');
        const mainContentArea = document.getElementById('mainContentArea');
        const promptSuggestions = document.getElementById('promptSuggestions');
        const charCount = document.getElementById('charCount');
        const fileUploadListContainer = document.getElementById('fileUploadListContainer');
        const fileList = document.getElementById('fileList');
        const dragOverlay = document.getElementById('drag-overlay');
        const messageInputContainer = document.getElementById('messageInputContainer');
        const imagineCommandDisplay = document.getElementById('imagineCommandDisplay');
        const fileContentDisplay = document.getElementById('fileContentDisplay');
        const fileContentText = document.getElementById('fileContentText');
        const clearFileContentBtn = document.getElementById('clearFileContentBtn');
        
        // Buttons
        const modelSelectBtn = document.getElementById('modelSelectBtn');
        const currentModelName = document.getElementById('currentModelName');
        const imageGenBtn = document.getElementById('imageGenBtn');
        const attachFileBtn = document.getElementById('attachFileBtn');
        const pageSettingsBtn = document.getElementById('pageSettingsBtn');

        // Modals & Forms
        const modelSettingsModal = document.getElementById('modelSettingsModal');
        const fileUploadModal = document.getElementById('fileUploadModal');
        const pageSettingsModal = document.getElementById('pageSettingsModal');
        const renameConversationModal = document.getElementById('renameConversationModal');
        const deleteConfirmModal = document.getElementById('deleteConfirmModal');
        const messageDeleteConfirmModal = document.getElementById('messageDeleteConfirmModal');
        const fileDropArea = document.getElementById('fileDropArea');
        const fileInput = document.getElementById('fileInput');
        const chatModelSelect = document.getElementById('chatModelSelect');
        const imageModelSelect = document.getElementById('imageModelSelect');
        const imageSizeSelect = document.getElementById('imageSizeSelect');
        const streamToggle = document.getElementById('streamToggle');
        const temperatureSlider = document.getElementById('temperatureSlider');
        const temperatureValue = document.getElementById('temperatureValue');
        const maxTokensInput = document.getElementById('maxTokensInput');
        const contextRoundsSlider = document.getElementById('contextRoundsSlider');
        const contextRoundsValue = document.getElementById('contextRoundsValue');
        const guidanceScaleSlider = document.getElementById('guidanceScaleSlider');
        const guidanceScaleValue = document.getElementById('guidanceScaleValue');
        const inferenceStepsSlider = document.getElementById('inferenceStepsSlider');
        const inferenceStepsValue = document.getElementById('inferenceStepsValue');
        const maxContextLength = document.getElementById('maxContextLength');

        // State Variables
        let conversations = [];
        let currentConversationId = null;
        let sidebarVisible = true;
        let isImageGenMode = false;
        let md; // Markdown-it instance
        let uploadedFiles = [];
        let failedFiles = []; // å­˜å‚¨è§£æå¤±è´¥çš„æ–‡ä»¶
        const IMAGE_GEN_PREFIX = "/imagine ";

        // State variables for stop functionality
        let isGenerating = false;
        let abortController = null;
        
        // Thinking animation HTML
        const THINKING_ANIMATION = `
            <div class="thinking-animation">
                <div class="thinking-dot"></div>
                <div class="thinking-dot"></div>
                <div class="thinking-dot"></div>
                <span style="margin-left: 8px;">æ­£åœ¨æ€è€ƒä¸­...</span>
            </div>
        `;
        
        // API Configuration
        const API_KEY = "sk-yptzbigpwpaiknvixhrhqcwodgzekskfcernrcirnmdregmv";
        const API_BASE = "https://api.siliconflow.cn/v1";

        // Initialization
        document.addEventListener('DOMContentLoaded', () => {
            md = window.markdownit({
                html: true,
                linkify: true,
                typographer: true,
                highlight: function (str, lang) {
                    let codeContent = '';
                    
                    if (lang && hljs.getLanguage(lang)) {
                        try {
                            codeContent = hljs.highlight(str, { language: lang, ignoreIllegals: true }).value;
                        } catch (__) {
                            codeContent = md.utils.escapeHtml(str);
                        }
                    } else {
                        codeContent = md.utils.escapeHtml(str);
                    }
                    
                    // é‡è¦ï¼šåªè¿”å›codeæ ‡ç­¾å†…å®¹ï¼Œmarkdown-itä¼šè‡ªåŠ¨ç”¨preåŒ…è£…
                    return `<code class="${lang ? 'language-' + lang : ''} hljs">${codeContent}</code>`;
                }
            });

            // å®Œå…¨ç§»é™¤fenceè§„åˆ™çš„é‡å†™ï¼Œé¿å…é‡å¤åŒ…è£…
            // ä¸è¦æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š
            // const defaultRender = md.renderer.rules.fence || function(tokens, idx, options, env, self) {
            //     return self.renderToken(tokens, idx, options);
            // };
            // md.renderer.rules.fence = function(tokens, idx, options, env, self) {
            //     const token = tokens[idx];
            //     const rawCode = defaultRender(tokens, idx, options, env, self);
            //     return `<pre>${rawCode}</pre>`;
            // };

            populateModelSelectors();
            loadConversations();
            loadSettings();
            setupEventListeners();
            
            if (conversations.length === 0) {
                createNewConversation();
            } else {
                const sortedConversations = [...conversations].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                loadConversation(sortedConversations[0].id);
            }
            
            if (window.innerWidth <= 768) {
                toggleSidebar(false);
            }
            
            updateUILayout();
        });
        
        function populateModelSelectors() {
            chatModelSelect.innerHTML = '';
            imageModelSelect.innerHTML = '';
            
            const sortedChatModels = [...MODELS_CONFIG.chat].sort((a, b) => b.supportsThinking - a.supportsThinking || a.name.localeCompare(b.name));

            sortedChatModels.forEach(model => {
                const option = document.createElement('option');
                option.value = model.id;
                option.textContent = `${model.name}${model.supportsThinking ? ' (âœ¨æ”¯æŒæ€è€ƒ)' : ''}`;
                option.dataset.maxContext = model.maxContext;
                option.dataset.supportsThinking = model.supportsThinking;
                chatModelSelect.appendChild(option);
            });

            MODELS_CONFIG.image.forEach(model => {
                const option = document.createElement('option');
                option.value = model.id;
                option.textContent = model.name;
                imageModelSelect.appendChild(option);
            });
        }

        function setupEventListeners() {
            sidebarToggleBtn.addEventListener('click', () => toggleSidebar());
            closeSidebarBtn.addEventListener('click', () => toggleSidebar(false));

            // Unified event listener for send/stop button
            sendMessageBtn.addEventListener('click', handleSendStopClick);
            
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendStopClick();
                }
                
                // ä¿®å¤é—®é¢˜1ï¼šæ”¹è¿› /imagine å‘½ä»¤çš„åˆ é™¤é€»è¾‘
                if (isImageGenMode && e.key === 'Backspace') {
                    const currentValue = messageInput.value;
                    const cursorPosition = messageInput.selectionStart;
                    
                    // åªæœ‰å½“å…‰æ ‡åœ¨ /imagine å‘½ä»¤ä¹‹åï¼Œå¹¶ä¸”å†…å®¹åªå‰©ä¸‹å‘½ä»¤æœ¬èº«æ—¶ï¼Œæ‰é€€å‡ºå›¾ç‰‡ç”Ÿæˆæ¨¡å¼
                    if (currentValue === IMAGE_GEN_PREFIX || 
                        (cursorPosition <= IMAGE_GEN_PREFIX.length && currentValue.startsWith(IMAGE_GEN_PREFIX))) {
                        e.preventDefault();
                        toggleImageGenMode(false);
                        return;
                    }
                    
                    // å¦‚æœç”¨æˆ·æ­£åœ¨åˆ é™¤ /imagine å‘½ä»¤ä¹‹åçš„å†…å®¹ï¼Œå…è®¸æ­£å¸¸åˆ é™¤
                    // ä¸é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼Œè®©æµè§ˆå™¨æ­£å¸¸å¤„ç†é€€æ ¼é”®
                }
            });
            
            messageInput.addEventListener('input', () => {
                updateCharCount();
                // ä¿®å¤é—®é¢˜1ï¼šæ£€æµ‹æ˜¯å¦è¾“å…¥äº† /imagine å‘½ä»¤
                checkImageGenMode();
            });

            newChatBtn.addEventListener('click', createNewConversation);
            newChatBtnTop.addEventListener('click', createNewConversation);
            
            chatMessages.addEventListener('click', handleChatAreaClick);

            modelSelectBtn.addEventListener('click', () => openModal(modelSettingsModal));
            document.getElementById('closeModelSettingsModal').addEventListener('click', () => closeModal(modelSettingsModal));
            document.getElementById('saveModelSettingsBtn').addEventListener('click', saveCurrentConversationSettings);
            
            // Update max tokens when model changes
            chatModelSelect.addEventListener('change', updateModelMaxContextDisplay);

            temperatureSlider.addEventListener('input', () => temperatureValue.textContent = parseFloat(temperatureSlider.value).toFixed(2));
            contextRoundsSlider.addEventListener('input', () => contextRoundsValue.textContent = contextRoundsSlider.value);
            guidanceScaleSlider.addEventListener('input', () => guidanceScaleValue.textContent = parseFloat(guidanceScaleSlider.value).toFixed(1));
            inferenceStepsSlider.addEventListener('input', () => inferenceStepsValue.textContent = inferenceStepsSlider.value);

            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.dataset.tab;
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });

            pageSettingsBtn.addEventListener('click', () => openModal(pageSettingsModal));
            document.getElementById('closePageSettingsModal').addEventListener('click', () => closeModal(pageSettingsModal));
            document.getElementById('savePageSettingsBtn').addEventListener('click', savePageSettings);

            attachFileBtn.addEventListener('click', () => openModal(fileUploadModal));
            fileDropArea.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
            document.getElementById('closeFileUploadModal').addEventListener('click', () => closeModal(fileUploadModal));
            
            mainContentArea.addEventListener('dragover', (e) => { e.preventDefault(); dragOverlay.classList.add('visible'); });
            mainContentArea.addEventListener('dragleave', () => { dragOverlay.classList.remove('visible'); });
            mainContentArea.addEventListener('drop', (e) => {
                e.preventDefault();
                dragOverlay.classList.remove('visible');
                if (e.dataTransfer.files.length > 0) handleFiles(e.dataTransfer.files);
            });
            
            setupConversationManagementListeners();

            window.addEventListener('resize', () => {
                if (window.innerWidth <= 768 && sidebarVisible) toggleSidebar(false);
                else if (window.innerWidth > 768 && !sidebarVisible) toggleSidebar(true);
            });
            
            promptSuggestions.addEventListener('click', (e) => {
                const card = e.target.closest('.prompt-card');
                if (!card) return;
                
                if (card.dataset.promptType === 'image') {
                    toggleImageGenMode(true, card.dataset.promptText);
                } else {
                    toggleImageGenMode(false);
                    messageInput.value = card.dataset.promptText;
                }
                messageInput.focus();
                updateCharCount();
            });

            imageGenBtn.addEventListener('click', () => toggleImageGenMode());
            
            // æ–°å¢ï¼šæ¶ˆæ¯åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡†äº‹ä»¶ç›‘å¬
            document.getElementById('closeMessageDeleteModal').addEventListener('click', () => closeModal(messageDeleteConfirmModal));
            document.getElementById('cancelMessageDeleteBtn').addEventListener('click', () => closeModal(messageDeleteConfirmModal));
            document.getElementById('confirmMessageDeleteBtn').addEventListener('click', confirmMessageDelete);
            
            // æ–°å¢ï¼šæ¸…é™¤æ–‡ä»¶å†…å®¹æŒ‰é’®äº‹ä»¶ç›‘å¬
            clearFileContentBtn.addEventListener('click', clearFileContent);
        }

        // --- UI & Layout ---
        function toggleSidebar(forceState) {
            sidebarVisible = typeof forceState === 'boolean' ? forceState : !sidebarVisible;
            if (sidebarVisible) {
                sidebar.classList.remove('w-0', 'p-0', 'border-0');
                sidebar.classList.add('w-64');
                sidebarToggleContainer.classList.add('hidden');
                sidebar.querySelectorAll('.p-4, .p-2').forEach(el => el.style.display = '');
            } else {
                sidebar.classList.add('w-0', 'p-0', 'border-0');
                sidebar.classList.remove('w-64');
                sidebarToggleContainer.classList.remove('hidden');
                sidebar.querySelectorAll('.p-4, .p-2').forEach(el => el.style.display = 'none');
            }
        }

        function updateUILayout() {
            const conversation = getCurrentConversation();
            const hasMessages = conversation && conversation.messages.length > 0;
            
            if (hasMessages) {
                welcomeAndInputContainer.style.display = 'none';
                chatContainer.style.display = 'block';
                mainContentArea.appendChild(inputSection); 
                inputSection.classList.add('p-4', 'border-t', 'border-gray-200', 'dark:border-gray-700');
                chatHeader.classList.remove('hidden');
            } else {
                welcomeAndInputContainer.style.display = 'flex';
                chatContainer.style.display = 'none';
                inputSectionContainer.appendChild(inputSection);
                inputSection.classList.remove('p-4', 'border-t', 'border-gray-200', 'dark:border-gray-700');
                chatHeader.classList.add('hidden');
            }
            scrollToBottom();
        }
        
        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function updateCharCount() {
            const conversation = getCurrentConversation();
            if (!conversation) return;

            const settings = conversation.settings.chat;
            const selectedModelConfig = MODELS_CONFIG.chat.find(m => m.id === settings.modelId);
            const currentMax = isImageGenMode ? 1000 : (selectedModelConfig?.maxContext || 128000);
            
            const len = messageInput.value.length;
            charCount.textContent = `${len}/${currentMax.toLocaleString()}`;
            charCount.classList.toggle('text-red-500', len > currentMax);
            
            messageInput.style.height = 'auto';
            const newHeight = Math.min(messageInput.scrollHeight, 300);
            messageInput.style.height = newHeight + 'px';
        }

        // --- Core Messaging & API Calls ---
        
        // Unified click handler for send/stop
        function handleSendStopClick() {
            if (isGenerating) {
                if (abortController) {
                    abortController.abort();
                    console.log("Request aborted by user.");
                }
            } else {
                sendMessage();
            }
        }

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message || isGenerating) return;

            const conversation = getCurrentConversation();
            if (!conversation) return;

            // ä¿®å¤é—®é¢˜2ï¼šæ£€æŸ¥æ˜¯å¦æœ‰è§£æå¤±è´¥çš„æ–‡ä»¶
            if (failedFiles.length > 0) {
                alert(`æœ‰ ${failedFiles.length} ä¸ªæ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·å…ˆåˆ é™¤è¿™äº›æ–‡ä»¶å†æé—®ã€‚`);
                return;
            }

            // ä¿®å¤é—®é¢˜3ï¼šæ£€æŸ¥æ–‡ä»¶å†…å®¹+ç”¨æˆ·æé—®æ˜¯å¦è¶…å‡ºæœ€å¤§é•¿åº¦
            const settings = conversation.settings.chat;
            const selectedModelConfig = MODELS_CONFIG.chat.find(m => m.id === settings.modelId);
            const maxContext = selectedModelConfig?.maxContext || 128000;
            
            // è®¡ç®—ç”¨æˆ·æ¶ˆæ¯é•¿åº¦
            const userMessageLength = message.length;
            
            // è®¡ç®—æ–‡ä»¶å†…å®¹é•¿åº¦ï¼ˆå¦‚æœæœ‰ï¼‰
            let fileContentLength = 0;
            if (conversation.fileContext) {
                fileContentLength = conversation.fileContext.length;
            }
            
            // æ€»é•¿åº¦æ£€æŸ¥
            const totalLength = userMessageLength + fileContentLength;
            if (totalLength > maxContext) {
                alert(`æ¶ˆæ¯å†…å®¹è¿‡é•¿ï¼ˆ${totalLength}å­—ç¬¦ï¼‰ï¼Œè¶…è¿‡äº†æ¨¡å‹çš„æœ€å¤§ä¸Šä¸‹æ–‡é•¿åº¦ï¼ˆ${maxContext}å­—ç¬¦ï¼‰ã€‚è¯·ç¼©çŸ­é—®é¢˜æˆ–å‡å°‘æ–‡ä»¶å†…å®¹ã€‚`);
                return;
            }

            const userMessageId = 'user-' + Date.now();
            
            // ä¿®å¤é—®é¢˜3ï¼šåªæ˜¾ç¤ºç”¨æˆ·æé—®çš„å†…å®¹ï¼Œä¸æ˜¾ç¤ºæ–‡ä»¶ç›¸å…³å†…å®¹
            addMessageToChat('user', message, false, userMessageId);
            
            // ä¿å­˜ç”¨æˆ·æ¶ˆæ¯ï¼ˆä¸åŒ…å«æ–‡ä»¶å†…å®¹ï¼‰
            conversation.messages.push({ role: 'user', content: message, id: userMessageId });
            
            // Save conversation immediately after user sends message
            saveConversations();
            
            messageInput.value = '';
            updateCharCount();
            updateUILayout();

            if (isImageGenMode) {
                const prompt = message.substring(IMAGE_GEN_PREFIX.length).trim();
                if(prompt) generateImage(prompt);
                toggleImageGenMode(false);
            } else {
                await callChatAPI();
            }
            
            // ä¿®å¤é—®é¢˜2ï¼šç”¨æˆ·ç¬¬ä¸€æ¬¡æé—®å‘é€æˆåŠŸåæ¸…é™¤æ–‡ä»¶åˆ—è¡¨å’Œæ–‡ä»¶å†…å®¹æ˜¾ç¤º
            clearFileList();
            clearFileContent();
        }
        
        function setGeneratingState(generating) {
            isGenerating = generating;
            sendMessageBtn.disabled = generating;
            messageInput.disabled = generating;
            
            if (generating) {
                sendBtnIcon.className = 'fas fa-stop';
                sendMessageBtn.title = "åœæ­¢";
                sendMessageBtn.disabled = false; // Re-enable for stopping
            } else {
                sendBtnIcon.className = 'fas fa-arrow-up';
                sendMessageBtn.title = "å‘é€";
                messageInput.disabled = false;
                abortController = null;
                messageInput.focus();
            }
        }

        async function callChatAPI() {
            const conversation = getCurrentConversation();
            if (!conversation) return;
            
            setGeneratingState(true);
            showTypingIndicator();
            abortController = new AbortController();

            try {
                const settings = conversation.settings.chat;
                
                // ä¿®å¤é—®é¢˜3ï¼šæ„å»ºåŒ…å«æ–‡ä»¶ä¸Šä¸‹æ–‡çš„æ¶ˆæ¯
                let messagesForContext = [];
                
                // å¦‚æœæœ‰æ–‡ä»¶ä¸Šä¸‹æ–‡ï¼Œå°†å…¶ä½œä¸ºç³»ç»Ÿæ¶ˆæ¯æ·»åŠ åˆ°æ¶ˆæ¯å¼€å¤´
                if (conversation.fileContext) {
                    messagesForContext.push({
                        role: 'system',
                        content: `ä»¥ä¸‹æ˜¯ç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶å†…å®¹ï¼Œè¯·æ ¹æ®è¿™äº›æ–‡ä»¶å†…å®¹å›ç­”ç”¨æˆ·çš„é—®é¢˜ï¼š\n\n${conversation.fileContext}`
                    });
                }
                
                // æ·»åŠ å¯¹è¯å†å²
                const historyMessages = conversation.messages.map(msg => ({ role: msg.role, content: msg.content }));
                messagesForContext = messagesForContext.concat(historyMessages);
                
                const rounds = settings.contextRounds;
                const userMessages = messagesForContext.filter(m => m.role === 'user');
                if (userMessages.length > rounds) {
                    const firstContextMessageIndex = messagesForContext.indexOf(userMessages[userMessages.length - rounds]);
                    messagesForContext = messagesForContext.slice(firstContextMessageIndex);
                }
                
                const requestData = {
                    model: settings.modelId,
                    messages: messagesForContext,
                    stream: settings.stream,
                    max_tokens: Math.min(parseInt(settings.maxTokens), 4096), // ç¡®ä¿ä¸è¶…è¿‡4096
                    temperature: settings.temperature,
                    top_p: 0.7
                };
                
                // Conditionally add thinking parameters
                const modelConfig = MODELS_CONFIG.chat.find(m => m.id === settings.modelId);
                if (modelConfig && modelConfig.supportsThinking) {
                    requestData.enable_thinking = true;
                }

                const response = await fetch(`${API_BASE}/chat/completions`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${API_KEY}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData),
                    signal: abortController.signal
                });
                
                hideTypingIndicator();

                if (!response.ok) {
                    let errorMessage = `API è¯·æ±‚å¤±è´¥, çŠ¶æ€ç : ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMessage += ` - ${errorData.error?.message || JSON.stringify(errorData)}`;
                    } catch (e) {
                        errorMessage += ` - ${response.statusText}`;
                    }
                    if (response.status === 403) errorMessage += " (è¯·æ£€æŸ¥API Keyæˆ–è´¦æˆ·ä½™é¢)";
                    throw new Error(errorMessage);
                }

                if (settings.stream) {
                    await handleStreamResponse(response);
                } else {
                    const data = await response.json();
                    const assistantMessage = data.choices[0].message.content;
                    const assistantMessageId = 'assistant-' + Date.now();
                    addMessageToChat('assistant', assistantMessage, true, assistantMessageId);
                    conversation.messages.push({ role: 'assistant', content: assistantMessage, id: assistantMessageId });
                    
                    if (conversation.messages.length <= 2) { 
                       updateConversationTitle(conversation, conversation.messages.find(m => m.role === 'user').content);
                    }
                    // Save conversation after non-stream reply
                    saveConversations();
                }
            } catch (error) {
                hideTypingIndicator();
                if (error.name === 'AbortError') {
                    console.log('Stream aborted by user.');
                    // The partially generated message is handled and saved by handleStreamResponse
                } else {
                    console.error('å‘é€æ¶ˆæ¯å‡ºé”™:', error);
                    const errorId = 'error-' + Date.now();
                    addMessageToChat('assistant', `æŠ±æ­‰ï¼Œè¯·æ±‚æ—¶å‡ºç°é”™è¯¯: ${error.message}`, false, errorId);
                    // Save conversation even if there is an error
                    conversation.messages.push({ role: 'assistant', content: `æŠ±æ­‰ï¼Œè¯·æ±‚æ—¶å‡ºç°é”™è¯¯: ${error.message}`, id: errorId });
                    saveConversations();
                }
            } finally {
                setGeneratingState(false);
            }
        }

        // Completely overhauled stream handler for thinking process and aborting
        async function handleStreamResponse(response) {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let assistantMessage = '';
            let thinkingMessage = '';
            let buffer = '';
            const assistantMessageId = 'assistant-' + Date.now();
            
            const messageElement = addMessageToChat('assistant', '', true, assistantMessageId);
            const contentElement = messageElement.querySelector('.final-content');
            const thinkingDetailsElement = messageElement.querySelector('.thinking-details');
            const thinkingContentElement = messageElement.querySelector('.thinking-content');
            
            let isThinkingBlock = false;
            const THINK_START_TAG = '<|thought|>';
            const THINK_END_TAG = '<|/thought|>';
            
            // æ˜¾ç¤ºæ€è€ƒåŠ¨ç”»
            thinkingDetailsElement.style.display = 'block';
            thinkingContentElement.innerHTML = THINKING_ANIMATION;

            try {
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    
                    let eventEndIndex;
                    while ((eventEndIndex = buffer.indexOf('\n\n')) !== -1) {
                        const eventData = buffer.substring(0, eventEndIndex);
                        buffer = buffer.substring(eventEndIndex + 2);

                        for (const line of eventData.split('\n')) {
                            if (line.startsWith('data: ')) {
                                if (line.includes('[DONE]')) continue;
                                try {
                                    const data = JSON.parse(line.substring(6));
                                    if (data.choices && data.choices[0].delta && data.choices[0].delta.content !== null) {
                                        let chunk = data.choices[0].delta.content || "";

                                        // Handle thinking block
                                        if (!isThinkingBlock && chunk.includes(THINK_START_TAG)) {
                                            isThinkingBlock = true;
                                            thinkingDetailsElement.style.display = 'block';
                                            const parts = chunk.split(THINK_START_TAG);
                                            assistantMessage += parts[0];
                                            chunk = parts[1] || '';
                                        }
                                        if (isThinkingBlock && chunk.includes(THINK_END_TAG)) {
                                            isThinkingBlock = false;
                                            const parts = chunk.split(THINK_END_TAG);
                                            thinkingMessage += parts[0];
                                            chunk = parts[1] || '';
                                        }

                                        if (isThinkingBlock) {
                                            thinkingMessage += chunk;
                                            // åªæœ‰å½“æœ‰å®é™…å†…å®¹æ—¶æ‰æ›´æ–°æ€è€ƒå†…å®¹
                                            if (thinkingMessage.trim()) {
                                                thinkingContentElement.innerHTML = md.render(thinkingMessage + 'â–Œ');
                                            }
                                        } else {
                                            assistantMessage += chunk;
                                            contentElement.innerHTML = md.render(assistantMessage + 'â–Œ');
                                        }
                                        scrollToBottom();
                                    }
                                } catch (e) {
                                    console.warn('Stream parsing error:', e, 'Line:', line);
                                }
                            }
                        }
                    }
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('Stream reading aborted.');
                    contentElement.innerHTML = md.render(assistantMessage + "\n\n*(ç”¨æˆ·å·²ä¸­æ–­)*");
                } else {
                    console.error('å¤„ç†æµå¼å“åº”å‡ºé”™:', error);
                    contentElement.innerHTML = `<p class="text-red-500">æŠ±æ­‰ï¼Œå¤„ç†å“åº”æ—¶å‡ºç°äº†é”™è¯¯: ${error.message}</p>`;
                }
            } finally {
                // Final render without the cursor
                contentElement.innerHTML = md.render(assistantMessage);
                if (thinkingMessage.trim()) {
                    thinkingContentElement.innerHTML = md.render(thinkingMessage);
                } else {
                    // å¦‚æœæ²¡æœ‰æ€è€ƒå†…å®¹ï¼Œéšè—æ€è€ƒåŒºå—
                    thinkingDetailsElement.style.display = 'none';
                }
                
                messageElement.dataset.rawContent = assistantMessage;
                addCopyButtonsToCodeBlocks(messageElement);

                if (thinkingDetailsElement && thinkingMessage.trim()) {
                    thinkingDetailsElement.open = false; // Collapse after generation
                } else {
                    thinkingDetailsElement.style.display = 'none'; // Hide if no thinking content
                }

                const conversation = getCurrentConversation();
                if (!conversation) return;
                
                // Add the (potentially partial) message to history and save
                conversation.messages.push({ role: 'assistant', content: assistantMessage, id: assistantMessageId });
                
                if (conversation.messages.length <= 2) {
                    updateConversationTitle(conversation, conversation.messages.find(m => m.role === 'user').content);
                }
                saveConversations();
            }
        }

        async function generateImage(prompt) {
            const conversation = getCurrentConversation();
            if (!conversation) return;

            setGeneratingState(true);
            showTypingIndicator();
            abortController = new AbortController();

            try {
                const settings = conversation.settings.image;
                const requestData = {
                    model: settings.modelId,
                    prompt: prompt,
                    n: 1, 
                    num_inference_steps: settings.inferenceSteps,
                    guidance_scale: settings.guidanceScale,
                    size: settings.size
                };
                
                const response = await fetch(`${API_BASE}/images/generations`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${API_KEY}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData),
                    signal: abortController.signal
                });

                hideTypingIndicator();
                
                if (!response.ok) {
                    let errorMessage = `å›¾ç‰‡ç”Ÿæˆå¤±è´¥, çŠ¶æ€ç : ${response.status}`;
                     try {
                        const errorData = await response.json();
                        errorMessage += ` - ${errorData.error?.message || JSON.stringify(errorData)}`;
                    } catch (e) {
                        errorMessage += ` - ${response.statusText}`;
                    }
                    if (response.status === 403) errorMessage += " (è¯·æ£€æŸ¥API Keyå’Œè´¦æˆ·çŠ¶æ€)";
                    throw new Error(errorMessage);
                }
                
                const data = await response.json();
                
                if (data.data && data.data[0] && data.data[0].url) {
                    const imageUrl = data.data[0].url;
                    const assistantMessageContent = `<p>æ ¹æ®æ‚¨çš„æè¿°"${md.utils.escapeHtml(prompt)}"ï¼Œæˆ‘ç”Ÿæˆäº†ä»¥ä¸‹å›¾ç‰‡ï¼š</p><img src="${imageUrl}" alt="${md.utils.escapeHtml(prompt)}" class="generated-image">`;
                    const assistantMessageId = 'assistant-' + Date.now();

                    addMessageToChat('assistant', assistantMessageContent, true, assistantMessageId);
                    
                    conversation.messages.push({ role: 'assistant', content: assistantMessageContent, id: assistantMessageId, isHtml: true });
                    if (conversation.messages.length <= 2) {
                        updateConversationTitle(conversation, `å›¾ç‰‡ï¼š${prompt}`);
                    }
                    saveConversations();
                } else { throw new Error('APIå“åº”ä¸­æœªæ‰¾åˆ°å›¾ç‰‡URL'); }
            } catch (error) {
                hideTypingIndicator();
                if (error.name === 'AbortError') {
                    console.log('Image generation aborted by user.');
                } else {
                    console.error('ç”Ÿæˆå›¾ç‰‡å‡ºé”™:', error);
                    const errorId = 'error-' + Date.now();
                    addMessageToChat('assistant', `æŠ±æ­‰ï¼Œç”Ÿæˆå›¾ç‰‡æ—¶å‡ºç°äº†é”™è¯¯: ${error.message}`, false, errorId);
                    conversation.messages.push({ role: 'assistant', content: `æŠ±æ­‰ï¼Œç”Ÿæˆå›¾ç‰‡æ—¶å‡ºç°äº†é”™è¯¯: ${error.message}`, id: errorId });
                    saveConversations();
                }
            } finally {
                setGeneratingState(false);
            }
        }

        // ä¿®å¤é—®é¢˜1å’Œé—®é¢˜3ï¼šæ”¹è¿›çš„å›¾ç‰‡ç”Ÿæˆæ¨¡å¼åˆ‡æ¢å‡½æ•°
        function toggleImageGenMode(forceState, initialPrompt = '') {
            const currentValue = messageInput.value; // è·å–åŸå§‹è¾“å…¥å€¼ï¼Œç”¨äºæ£€æŸ¥å‰ç¼€
            const wasImageGenMode = isImageGenMode;
            
            // ç¡®å®šæ–°çš„çŠ¶æ€
            isImageGenMode = typeof forceState === 'boolean' ? forceState : !isImageGenMode;
            
            if (isImageGenMode) {
                // è¿›å…¥å›¾ç‰‡ç”Ÿæˆæ¨¡å¼
                imageGenBtn.classList.add('bg-blue-100', 'text-blue-600', 'dark:bg-blue-900', 'dark:text-blue-300');
                messageInput.placeholder = "è¾“å…¥å›¾ç‰‡æè¿°ï¼Œç„¶åæŒ‰å‘é€..."; // è®¾ç½®å›¾ç‰‡æ¨¡å¼çš„placeholder
                
                // æ˜¾ç¤º /imagine å‘½ä»¤æç¤ºï¼ˆUIå…ƒç´ ï¼‰
                imagineCommandDisplay.classList.remove('hidden');
                
                // ä¿®å¤é—®é¢˜1ï¼šå¢å¤§paddingLeftçš„å€¼ï¼Œç¡®ä¿è¾“å…¥æ¡†å†…å®¹å’Œplaceholderä¸ä¼šä¸/imagineå‘½ä»¤é‡å 
                // 5.5rem å¯èƒ½ä¼šä¸å¤Ÿï¼Œæˆ‘ä»¬å°†å…¶è®¾ç½®ä¸º 7remï¼Œä¸º '/imagine' åŠå…¶å†…è¾¹è·ç•™å‡ºæ›´å¤šç©ºé—´
                messageInput.style.paddingLeft = '7rem'; 
                
                let newInputValue = currentValue;
                if (currentValue.startsWith(IMAGE_GEN_PREFIX)) {
                    // å¦‚æœè¾“å…¥æ¡†å†…å®¹å·²ç»åŒ…å« /imagine å‰ç¼€ï¼Œåˆ™ä»å®é™…è¾“å…¥æ¡†ä¸­ç§»é™¤å®ƒ
                    // è¿™æ ·è¾“å…¥æ¡†å†…éƒ¨åªä¿ç•™å®é™…çš„å›¾ç‰‡æè¿°
                    newInputValue = currentValue.substring(IMAGE_GEN_PREFIX.length);
                } else if (!wasImageGenMode && initialPrompt) {
                    // å¦‚æœåˆšåˆ‡æ¢åˆ°å›¾ç‰‡æ¨¡å¼ï¼Œå¹¶ä¸”æœ‰åˆå§‹æç¤ºï¼Œåˆ™ä½¿ç”¨å®ƒ
                    newInputValue = initialPrompt;
                }
                // å¦åˆ™ï¼Œå¦‚æœå½“å‰å€¼æ²¡æœ‰å‰ç¼€ä¸”æ²¡æœ‰åˆå§‹æç¤ºï¼Œä¿æŒå½“å‰å€¼ä¸å˜
                messageInput.value = newInputValue;
                
                // å°†å…‰æ ‡å®šä½åˆ°æ–‡æœ¬æœ«å°¾
                setTimeout(() => {
                    messageInput.setSelectionRange(messageInput.value.length, messageInput.value.length);
                }, 0);
            } else {
                // é€€å‡ºå›¾ç‰‡ç”Ÿæˆæ¨¡å¼
                imageGenBtn.classList.remove('bg-blue-100', 'text-blue-600', 'dark:bg-blue-900', 'dark:text-blue-300');
                messageInput.placeholder = "ç»™ AIæ™ºèƒ½åŠ©æ‰‹ å‘é€æ¶ˆæ¯ï¼Œæˆ–å°†æ–‡ä»¶æ‹–æ‹½åˆ°è¿™é‡Œ"; // æ¢å¤é»˜è®¤placeholder
                
                // éšè— /imagine å‘½ä»¤æç¤º
                imagineCommandDisplay.classList.add('hidden');
                // æ¢å¤é»˜è®¤çš„paddingLeft
                messageInput.style.paddingLeft = '1rem'; 
                
                // å½“é€€å‡ºæ¨¡å¼æ—¶ï¼Œç”±äºè¿›å…¥æ—¶å·²ç»å°† /imagine å‰ç¼€ä»è¾“å…¥æ¡†å†…å®¹ä¸­ç§»é™¤ï¼Œ
                // æ‰€ä»¥æ­¤å¤„æ— éœ€å†è¿›è¡Œç§»é™¤æ“ä½œã€‚è¾“å…¥æ¡†å†…å®¹å·²ç»æ˜¯çº¯ç²¹çš„ç”¨æˆ·è¾“å…¥ã€‚
                // ä¿æŒæ­¤å¤„çš„é€»è¾‘ä¸å˜ï¼Œè™½ç„¶åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹å®ƒä¸ä¼šå†ä¿®æ”¹ `messageInput.value`ã€‚
                if (currentValue.startsWith(IMAGE_GEN_PREFIX)) {
                    messageInput.value = currentValue.substring(IMAGE_GEN_PREFIX.length);
                }
            }
            updateCharCount();
            messageInput.focus();
        }
        
        // ä¿®å¤é—®é¢˜1ï¼šæ£€æµ‹æ˜¯å¦è¾“å…¥äº† /imagine å‘½ä»¤
        function checkImageGenMode() {
            const currentValue = messageInput.value;
            
            // åªæœ‰å½“è¾“å…¥æ¡†ä»¥ /imagine å¼€å¤´ä¸”åé¢æœ‰ç©ºæ ¼æ—¶æ‰è¿›å…¥å›¾ç‰‡ç”Ÿæˆæ¨¡å¼
            if (currentValue.startsWith(IMAGE_GEN_PREFIX) && currentValue.length >= IMAGE_GEN_PREFIX.length) {
                if (!isImageGenMode) {
                    toggleImageGenMode(true);
                }
            } else if (isImageGenMode && !currentValue.startsWith(IMAGE_GEN_PREFIX)) {
                // å¦‚æœå·²ç»ä¸åœ¨å›¾ç‰‡ç”Ÿæˆæ¨¡å¼ï¼Œä½†çŠ¶æ€è¿˜æ˜¯å›¾ç‰‡ç”Ÿæˆæ¨¡å¼ï¼Œåˆ™é€€å‡º
                toggleImageGenMode(false);
            }
        }
        
        function addMessageToChat(role, content, isMarkdownOrHtml = false, messageId) {
            const messageContainer = document.createElement('div');
            messageContainer.className = 'message-animation group relative';
            messageContainer.dataset.messageId = messageId;
            messageContainer.dataset.rawContent = content; 
            messageContainer.dataset.role = role;

            let messageContentHtml = '';
            if (isMarkdownOrHtml) {
                const isHtmlBlock = /<[a-z][\s\S]*>/i.test(content);
                messageContentHtml = isHtmlBlock ? content : md.render(content);
            } else {
                 messageContentHtml = md.render(content);
            }

            if (role === 'user') {
                messageContainer.innerHTML = `
                    <div class="flex items-start justify-end">
                        <div class="bg-blue-500 text-white rounded-lg p-3 message-bubble markdown-content">${messageContentHtml}</div>
                        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center ml-3 flex-shrink-0">
                            <i class="fas fa-user text-white"></i>
                        </div>
                    </div>
                    <div class="flex items-center justify-end mt-2 pr-11 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button data-action="copy" class="action-btn">
                            <i class="fas fa-copy"></i>
                            <span class="btn-text">å¤åˆ¶</span>
                        </button>
                        <!-- Added delete button for user message -->
                        <button data-action="delete" class="action-btn delete-btn">
                            <i class="fas fa-trash-alt"></i>
                            <span class="btn-text">åˆ é™¤</span>
                        </button>
                    </div>`;
            } else { // assistant
                messageContainer.innerHTML = `
                    <div class="flex items-start">
                        <div class="w-8 h-8 clover-bg rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                            <div class="clover-icon w-8 h-8"></div>
                        </div>
                        <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-3 w-full message-bubble">
                            <!-- Thinking Process Block -->
                            <details class="thinking-details" style="display: none;">
                                <summary class="text-sm">ğŸ¤” æ€è€ƒä¸­...</summary>
                                <div class="thinking-content markdown-content"></div>
                            </details>
                            <div class="markdown-content final-content">${messageContentHtml}</div>
                        </div>
                    </div>
                    <div class="flex items-center justify-start mt-2 pl-11 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button data-action="regenerate" class="action-btn">
                            <i class="fas fa-sync-alt"></i>
                            <span class="btn-text">é‡æ–°ç”Ÿæˆ</span>
                        </button>
                        <button data-action="copy" class="action-btn">
                            <i class="fas fa-copy"></i>
                            <span class="btn-text">å¤åˆ¶</span>
                        </button>
                        <!-- Added delete button for assistant message -->
                        <button data-action="delete" class="action-btn delete-btn">
                            <i class="fas fa-trash-alt"></i>
                            <span class="btn-text">åˆ é™¤</span>
                        </button>
                    </div>`;
            }
            
            chatMessages.appendChild(messageContainer);
            
            if (isMarkdownOrHtml) {
                addCopyButtonsToCodeBlocks(messageContainer);
            }

            scrollToBottom();
            return messageContainer;
        }

        function showTypingIndicator() {
            hideTypingIndicator();
            const typingIndicator = document.createElement('div');
            typingIndicator.id = 'typingIndicator';
            typingIndicator.className = 'flex items-start message-animation';
            typingIndicator.innerHTML = `<div class="w-8 h-8 clover-bg rounded-full flex items-center justify-center mr-3 flex-shrink-0"><div class="clover-icon w-4 h-4"></div></div><div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-3 max-w-xs"><div class="typing-dots"><span class="w-2 h-2 bg-gray-500 rounded-full"></span><span class="w-2 h-2 bg-gray-500 rounded-full"></span><span class="w-2 h-2 bg-gray-500 rounded-full"></span></div></div>`;
            chatMessages.appendChild(typingIndicator);
            scrollToBottom();
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator')?.remove();
        }
        
        function handleChatAreaClick(e) {
            const button = e.target.closest('button');
            if (!button) return;

            const action = button.dataset.action;
            const messageContainer = button.closest('.group[data-message-id]');
            
            if (button.classList.contains('copy-code-button')) {
                const preElement = button.closest('pre');
                if(preElement) {
                    const codeBlock = preElement.querySelector('code');
                    copyToClipboard(codeBlock.innerText, button);
                }
                return;
            }

            if (!action || !messageContainer) return;
            const messageId = messageContainer.dataset.messageId;

            if (action === 'copy') {
                const rawContent = messageContainer.dataset.rawContent;
                copyToClipboard(rawContent, button);
            } else if (action === 'regenerate') {
                handleRegeneration(messageContainer, messageId);
            } else if (action === 'delete') {
                // Handle message deletion with confirmation
                messageDeleteConfirmModal.dataset.messageId = messageId;
                openModal(messageDeleteConfirmModal);
            }
        }
        
        // Function to handle message deletion with confirmation
        function confirmMessageDelete() {
            const messageId = messageDeleteConfirmModal.dataset.messageId;
            const conversation = getCurrentConversation();
            if (!conversation) return;

            const messageIndex = conversation.messages.findIndex(m => m.id === messageId);
            if (messageIndex > -1) {
                conversation.messages.splice(messageIndex, 1);
                saveConversations();
                
                const messageElement = chatMessages.querySelector(`[data-message-id="${messageId}"]`);
                if (messageElement) {
                    messageElement.remove();
                }
                // If no messages left, reset to welcome screen
                if (conversation.messages.length === 0) {
                    updateUILayout();
                }
            }
            closeModal(messageDeleteConfirmModal);
        }

        function handleRegeneration(messageContainer, messageId) {
            const conversation = getCurrentConversation();
            if (!conversation) return;

            const messageIndex = conversation.messages.findIndex(m => m.id === messageId);
            if (messageIndex === -1) return;

            // Remove the assistant's message and all subsequent messages from the DOM
            const messagesToRemove = Array.from(chatMessages.querySelectorAll('.group'));
            const startIndex = messagesToRemove.findIndex(el => el.dataset.messageId === messageId);
            if(startIndex > -1) {
                messagesToRemove.slice(startIndex).forEach(el => el.remove());
            }

            // Remove messages from the data model (from the assistant message onwards)
            conversation.messages.splice(messageIndex);
            
            saveConversations();
            
            callChatAPI();
        }
        
        function addCopyButtonsToCodeBlocks(container) {
            container.querySelectorAll('pre').forEach(pre => {
                if (pre.querySelector('.copy-code-button')) return;
                const copyButton = document.createElement('button');
                copyButton.innerHTML = '<i class="fas fa-copy"></i>';
                copyButton.className = 'copy-code-button';
                copyButton.title = 'å¤åˆ¶';
                pre.appendChild(copyButton);
            });
        }
        
        function copyToClipboard(text, buttonElement) {
            navigator.clipboard.writeText(text).then(() => {
                const originalContent = buttonElement.innerHTML;
                const btnTextEl = buttonElement.querySelector('.btn-text');
                const originalTitle = btnTextEl ? btnTextEl.textContent : 'å¤åˆ¶';

                if (btnTextEl) {
                    buttonElement.querySelector('i').className = 'fas fa-check';
                    btnTextEl.textContent = 'å·²å¤åˆ¶';
                } else {
                    buttonElement.innerHTML = '<i class="fas fa-check"></i>';
                }

                setTimeout(() => {
                    buttonElement.innerHTML = originalContent;
                    if(btnTextEl) btnTextEl.textContent = originalTitle;
                }, 2000);
            }).catch(err => {
                console.error('æ— æ³•å¤åˆ¶æ–‡æœ¬: ', err);
            });
        }

        // --- File Handling ---
        function handleFiles(files) {
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (!['xlsx', 'xls', 'txt', 'pdf', 'doc', 'docx'].includes(file.name.split('.').pop().toLowerCase())) {
                    alert(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${file.name}`);
                    continue;
                }
                uploadedFiles.push(file);
                addFileToList(file);
            }
            fileInput.value = '';
            closeModal(fileUploadModal);
            processFiles();
        }
        
        function addFileToList(file) {
            const fileItem = document.createElement('div');
            fileItem.className = 'bg-gray-100 dark:bg-gray-700 rounded-full py-1 pl-2 pr-1 flex items-center text-sm relative flex-shrink-0';
            const fileId = `file-${Date.now()}-${Math.random()}`;
            fileItem.dataset.fileId = fileId;
            file.id = fileId;
            fileItem.innerHTML = `<i class="fas fa-spinner fa-spin text-gray-500 dark:text-gray-300 text-xs"></i><span class="ml-1.5 mr-2 truncate max-w-[150px]" title="${file.name}">${file.name}</span><button class="w-4 h-4 bg-gray-300 text-white rounded-full flex items-center justify-center text-xs hover:bg-red-500 transition-colors" onclick="removeFile('${fileId}')">&times;</button>`;
            fileList.appendChild(fileItem);
            fileUploadListContainer.classList.remove('hidden');
        }
        
        function removeFile(fileId) {
            uploadedFiles = uploadedFiles.filter(f => f.id !== fileId);
            failedFiles = failedFiles.filter(f => f.id !== fileId);
            document.querySelector(`[data-file-id="${fileId}"]`)?.remove();
            if (uploadedFiles.length === 0) fileUploadListContainer.classList.add('hidden');
            
            // å¦‚æœæ‰€æœ‰æ–‡ä»¶éƒ½è¢«ç§»é™¤ï¼Œä¹Ÿæ¸…é™¤æ–‡ä»¶å†…å®¹æ˜¾ç¤º
            if (uploadedFiles.length === 0 && failedFiles.length === 0) {
                clearFileContent();
            }
        }
        
        // ä¿®å¤é—®é¢˜2ï¼šæ¸…é™¤æ–‡ä»¶åˆ—è¡¨
        function clearFileList() {
            uploadedFiles = [];
            failedFiles = [];
            fileList.innerHTML = '';
            fileUploadListContainer.classList.add('hidden');
        }
        
        // ä¿®å¤é—®é¢˜2ï¼šæ¸…é™¤æ–‡ä»¶å†…å®¹æ˜¾ç¤º
        function clearFileContent() {
            fileContentDisplay.classList.add('hidden');
            fileContentText.innerHTML = '';
            const conversation = getCurrentConversation();
            if (conversation) {
                conversation.fileContext = null;
                saveConversations();
            }
        }
        
        async function processFiles() {
            if (uploadedFiles.length === 0) return;
            showTypingIndicator();
            try {
                let fileContents = [];
                failedFiles = []; // é‡ç½®å¤±è´¥æ–‡ä»¶åˆ—è¡¨
                
                for (const file of uploadedFiles) {
                    try {
                        const content = await readFileContent(file);
                        fileContents.push({ name: file.name, content: content });
                        const fileItem = document.querySelector(`[data-file-id="${file.id}"] i`);
                        if(fileItem) fileItem.className = 'fas fa-check-circle text-green-600 dark:text-green-400 text-xs';
                    } catch (error) {
                        console.error(`å¤„ç†æ–‡ä»¶ ${file.name} å‡ºé”™:`, error);
                        failedFiles.push(file);
                        const fileItem = document.querySelector(`[data-file-id="${file.id}"] i`);
                        if(fileItem) {
                            fileItem.className = 'fas fa-times-circle text-red-600 dark:text-red-400 text-xs';
                            fileItem.parentElement.classList.add('file-error');
                        }
                    }
                }
                
                // æ˜¾ç¤ºæ–‡ä»¶å†…å®¹
                if (fileContents.length > 0) {
                    const combinedFileContent = fileContents.map(f => `æ–‡ä»¶å: ${f.name}\nå†…å®¹:\n${f.content}`).join('\n\n---\n\n');
                    
                    fileContentText.textContent = combinedFileContent.substring(0, 1000) + (combinedFileContent.length > 1000 ? '...' : '');
                    fileContentDisplay.classList.remove('hidden');
                    
                    const conversation = getCurrentConversation();
                    if (conversation) {
                        // å°†æ–‡ä»¶å†…å®¹å­˜å‚¨åˆ°å¯¹è¯ä¸Šä¸‹æ–‡ä¸­
                        conversation.fileContext = combinedFileContent;
                        saveConversations();
                    }
                }
                
                // å¦‚æœæœ‰è§£æå¤±è´¥çš„æ–‡ä»¶ï¼Œæ˜¾ç¤ºæç¤º
                if (failedFiles.length > 0) {
                    const failedFileNames = failedFiles.map(f => f.name).join(', ');
                    alert(`ä»¥ä¸‹æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·åˆ é™¤è¿™äº›æ–‡ä»¶åå†æé—®ï¼š${failedFileNames}`);
                }
                
                hideTypingIndicator();
            } catch (error) {
                console.error('å¤„ç†æ–‡ä»¶å‡ºé”™:', error);
                hideTypingIndicator();
                addMessageToChat('assistant', `æŠ±æ­‰ï¼Œå¤„ç†æ–‡ä»¶æ—¶å‡ºç°äº†é”™è¯¯: ${error.message}`, false, 'error-' + Date.now());
            }
        }
        
        function readFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                const fileExt = file.name.split('.').pop().toLowerCase();
                reader.onload = async function(e) {
                    try {
                        let content = '';
                        const arrayBuffer = e.target.result;
                        if (fileExt === 'txt') { content = new TextDecoder().decode(arrayBuffer); }
                        else if (fileExt === 'pdf') {
                            const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                            let text = '';
                            for (let i = 1; i <= pdf.numPages; i++) {
                                const page = await pdf.getPage(i);
                                const textContent = await page.getTextContent();
                                text += textContent.items.map(item => item.str).join(' ');
                            }
                            content = text;
                        } else if (['xlsx', 'xls'].includes(fileExt)) {
                            const workbook = XLSX.read(arrayBuffer, {type: 'array'});
                            workbook.SheetNames.forEach(sheetName => { content += `å·¥ä½œè¡¨: ${sheetName}\n${XLSX.utils.sheet_to_csv(workbook.Sheets[sheetName])}\n\n`; });
                        } else if (['doc', 'docx'].includes(fileExt)) {
                            content = (await mammoth.extractRawText({arrayBuffer: arrayBuffer})).value;
                        }
                        resolve(content);
                    } catch (error) { reject(error); }
                };
                reader.onerror = () => reject(new Error('è¯»å–æ–‡ä»¶å¤±è´¥'));
                reader.readAsArrayBuffer(file);
            });
        }

        // --- Conversation Management & Settings ---
        function createNewConversation() {
            // ä¿®å¤é—®é¢˜2ï¼šå¦‚æœå½“å‰æœ‰å¯¹è¯æ­£åœ¨è¿›è¡Œï¼Œåˆ™åœæ­¢å®ƒå¹¶æˆªæ–­è¾“å‡º
            if (isGenerating && abortController) {
                abortController.abort();
                setGeneratingState(false);
                
                // æˆªæ–­å½“å‰å¯¹è¯çš„è¾“å‡ºå†…å®¹ï¼Œåªä¿ç•™å·²ç”Ÿæˆçš„éƒ¨åˆ†
                const conversation = getCurrentConversation();
                if (conversation && conversation.messages.length > 0) {
                    const lastMessage = conversation.messages[conversation.messages.length - 1];
                    if (lastMessage.role === 'assistant') {
                        // è·å–å½“å‰æ˜¾ç¤ºçš„æœ€åä¸€ä¸ªæ¶ˆæ¯å†…å®¹
                        const lastMessageElement = chatMessages.querySelector(`[data-message-id="${lastMessage.id}"]`);
                        if (lastMessageElement) {
                            const currentContent = lastMessageElement.dataset.rawContent;
                            lastMessage.content = currentContent;
                        }
                    }
                }
            }
            
            toggleImageGenMode(false);
            clearFileContent(); // æ¸…é™¤æ–‡ä»¶å†…å®¹
            clearFileList(); // æ¸…é™¤æ–‡ä»¶åˆ—è¡¨
            
            const newConv = { 
                id: Date.now().toString(), 
                title: 'æ–°å¯¹è¯', 
                messages: [], 
                createdAt: new Date().toISOString(),
                settings: JSON.parse(JSON.stringify(DEFAULT_SETTINGS)),
                fileContext: null // ä¿®å¤é—®é¢˜3ï¼šæ·»åŠ æ–‡ä»¶ä¸Šä¸‹æ–‡å­—æ®µ
            };
            conversations.push(newConv);
            saveConversations();
            loadConversation(newConv.id);
            if (window.innerWidth <= 768) toggleSidebar(false);
        }
        
        function loadConversation(id) {
            // ä¿®å¤é—®é¢˜2ï¼šå¦‚æœå½“å‰æœ‰å¯¹è¯æ­£åœ¨è¿›è¡Œï¼Œåˆ™åœæ­¢å®ƒ
            if (isGenerating && abortController) {
                abortController.abort();
                setGeneratingState(false);
            }
            
            const conversation = conversations.find(c => c.id === id);
            if (!conversation) return;

            if (!conversation.settings) {
                conversation.settings = JSON.parse(JSON.stringify(DEFAULT_SETTINGS));
            }
            
            // ä¿®å¤é—®é¢˜3ï¼šç¡®ä¿æ–‡ä»¶ä¸Šä¸‹æ–‡å­—æ®µå­˜åœ¨
            if (!conversation.fileContext) {
                conversation.fileContext = null;
            }

            currentConversationId = id;
            chatMessages.innerHTML = '';
            
            // åªæ˜¾ç¤ºç”¨æˆ·å’ŒAIçš„çœŸå®å¯¹è¯æ¶ˆæ¯ï¼Œä¸æ˜¾ç¤ºæ–‡ä»¶å‡†å¤‡æ¶ˆæ¯
            conversation.messages.forEach(msg => {
                // è¿‡æ»¤æ‰æ–‡ä»¶å‡†å¤‡å°±ç»ªçš„æ¶ˆæ¯
                if (!msg.content.includes('æ–‡ä»¶å·²å‡†å¤‡å°±ç»ª')) {
                    addMessageToChat(msg.role, msg.content, msg.isHtml || msg.role === 'assistant', msg.id);
                }
            });
            
            chatTitle.textContent = conversation.title;
            
            loadSettingsIntoUI(conversation.settings);
            updateUILayout();
            updateConversationList();
            
            // å¦‚æœæœ‰æ–‡ä»¶ä¸Šä¸‹æ–‡ï¼Œæ˜¾ç¤ºæ–‡ä»¶å†…å®¹
            if (conversation.fileContext) {
                fileContentText.textContent = conversation.fileContext.substring(0, 1000) + (conversation.fileContext.length > 1000 ? '...' : '');
                fileContentDisplay.classList.remove('hidden');
            } else {
                fileContentDisplay.classList.add('hidden');
            }
        }

        function loadSettingsIntoUI(settings) {
            chatModelSelect.value = settings.chat.modelId;
            temperatureSlider.value = settings.chat.temperature;
            temperatureValue.textContent = parseFloat(settings.chat.temperature).toFixed(2);
            contextRoundsSlider.value = settings.chat.contextRounds;
            contextRoundsValue.textContent = settings.chat.contextRounds;
            streamToggle.checked = settings.chat.stream;

            // Set max tokens and update UI correctly when loading a conversation
            maxTokensInput.max = 4096; // å¼ºåˆ¶æœ€å¤§å€¼ä¸º4096
            maxTokensInput.value = Math.min(settings.chat.maxTokens, 4096); // ç¡®ä¿ä¸è¶…è¿‡4096

            imageModelSelect.value = settings.image.modelId;
            imageSizeSelect.value = settings.image.size;
            guidanceScaleSlider.value = settings.image.guidanceScale;
            guidanceScaleValue.textContent = parseFloat(settings.image.guidanceScale).toFixed(1);
            inferenceStepsSlider.value = settings.image.inferenceSteps;
            inferenceStepsValue.textContent = settings.image.inferenceSteps;

            updateModelDisplay(settings.chat.modelId);
            updateModelMaxContextDisplay();
        }
        
        function saveCurrentConversationSettings() {
            const conversation = getCurrentConversation();
            if (!conversation) return;

            conversation.settings.chat.modelId = chatModelSelect.value;
            conversation.settings.chat.temperature = parseFloat(temperatureSlider.value);
            conversation.settings.chat.maxTokens = Math.min(parseInt(maxTokensInput.value) || 4096, 4096); // ç¡®ä¿ä¸è¶…è¿‡4096
            conversation.settings.chat.contextRounds = parseInt(contextRoundsSlider.value);
            conversation.settings.chat.stream = streamToggle.checked;
            
            conversation.settings.image.modelId = imageModelSelect.value;
            conversation.settings.image.size = imageSizeSelect.value;
            conversation.settings.image.guidanceScale = parseFloat(guidanceScaleSlider.value);
            conversation.settings.image.inferenceSteps = parseInt(inferenceStepsSlider.value);

            saveConversations();
            updateModelDisplay(conversation.settings.chat.modelId);
            closeModal(modelSettingsModal);
        }
        
        function updateConversationTitle(conversation, userMessage) {
            if (!userMessage) return;
            conversation.title = userMessage.substring(0, 30) + (userMessage.length > 30 ? '...' : '');
            updateConversationList();
            chatTitle.textContent = conversation.title;
        }

        function updateConversationList() {
            historyList.innerHTML = '';
            if (conversations.length === 0) return;
            const sortedConversations = [...conversations].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            sortedConversations.forEach(conv => {
                const isActive = conv.id === currentConversationId;
                const item = document.createElement('div');
                item.className = `relative p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer transition-colors ${isActive ? 'bg-blue-50 dark:bg-blue-900/50' : ''}`;
                item.dataset.id = conv.id;
                item.innerHTML = `<div class="flex items-center justify-between"><div class="text-sm text-gray-700 dark:text-gray-200 truncate flex-1 pr-8">${conv.title}</div><button class="absolute right-1 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-800 dark:hover:text-white p-2 rounded-full w-8 h-8 flex items-center justify-center" data-menuid="${conv.id}"><i class="fas fa-ellipsis-h text-xs"></i></button></div>`;
                historyList.appendChild(item);
            });
        }
        
        function setupConversationManagementListeners() {
            historyList.addEventListener('click', (e) => {
                const convItem = e.target.closest('[data-id]');
                const menuButton = e.target.closest('[data-menuid]');
                if (menuButton) { e.stopPropagation(); toggleConversationMenu(menuButton.dataset.menuid, menuButton); }
                else if (convItem) { loadConversation(convItem.dataset.id); }
            });
            document.getElementById('saveRenameBtn').addEventListener('click', () => {
                const newTitle = document.getElementById('renameInput').value.trim();
                const idToRename = renameConversationModal.dataset.id;
                if (!newTitle || !idToRename) return;
                const conversation = conversations.find(c => c.id === idToRename);
                if (conversation) {
                    conversation.title = newTitle;
                    if (currentConversationId === idToRename) chatTitle.textContent = newTitle;
                    updateConversationList(); saveConversations();
                }
                closeModal(renameConversationModal);
            });
            document.getElementById('closeRenameModal').addEventListener('click', () => closeModal(renameConversationModal));
            document.getElementById('cancelRenameBtn').addEventListener('click', () => closeModal(renameConversationModal));
            document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
                const idToDelete = deleteConfirmModal.dataset.id;
                if (!idToDelete) return;
                conversations = conversations.filter(c => c.id !== idToDelete);
                if (currentConversationId === idToDelete) {
                    if (conversations.length > 0) {
                        const sorted = [...conversations].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                        loadConversation(sorted[0].id);
                    } else { createNewConversation(); }
                } else {
                    updateConversationList();
                }
                saveConversations(); 
                closeModal(deleteConfirmModal);
            });
            document.getElementById('closeDeleteModal').addEventListener('click', () => closeModal(deleteConfirmModal));
            document.getElementById('cancelDeleteBtn').addEventListener('click', () => closeModal(deleteConfirmModal));
            document.addEventListener('click', (e) => { if (!e.target.closest('.conversation-dropdown') && !e.target.closest('[data-menuid]')) { document.querySelectorAll('.conversation-dropdown').forEach(d => d.remove()); } });
        }
        
        function toggleConversationMenu(id, button) {
            document.querySelectorAll('.conversation-dropdown').forEach(d => d.remove());
            const dropdown = document.createElement('div');
            dropdown.className = 'conversation-dropdown';
            dropdown.innerHTML = `<button data-action="rename" data-id="${id}"><i class="fas fa-pen w-6 text-center mr-1"></i>é‡å‘½å</button><button data-action="delete" data-id="${id}" class="text-red-500 hover:bg-red-50 dark:hover:bg-red-900/50"><i class="fas fa-trash w-6 text-center mr-1"></i>åˆ é™¤</button>`;
            button.parentElement.parentElement.appendChild(dropdown);
            dropdown.addEventListener('click', e => {
                const actionBtn = e.target.closest('button');
                if (!actionBtn) return;
                const conversationId = actionBtn.dataset.id;
                if (actionBtn.dataset.action === 'rename') {
                    renameConversationModal.dataset.id = conversationId;
                    const conversation = conversations.find(c => c.id === conversationId);
                    document.getElementById('renameInput').value = conversation ? conversation.title : '';
                    openModal(renameConversationModal);
                } else if (actionBtn.dataset.action === 'delete') {
                    deleteConfirmModal.dataset.id = conversationId;
                    openModal(deleteConfirmModal);
                }
                dropdown.remove();
            });
        }
        
        function openModal(modal) { modal.classList.remove('hidden'); }
        function closeModal(modal) { modal.classList.add('hidden'); }
        
        function updateModelDisplay(modelId) {
            const model = MODELS_CONFIG.chat.find(m => m.id === modelId);
            if (model) {
                currentModelName.textContent = model.name;
            }
            updateCharCount();
        }

        // Function to update max tokens based on model selection
        function updateModelMaxContextDisplay() {
            const selectedOption = chatModelSelect.options[chatModelSelect.selectedIndex];
            if (selectedOption && selectedOption.dataset.maxContext) {
                const maxCtx = parseInt(selectedOption.dataset.maxContext);
                maxContextLength.textContent = maxCtx.toLocaleString();
                maxTokensInput.max = 4096; // å¼ºåˆ¶æœ€å¤§å€¼ä¸º4096
                // è®¾ç½®é»˜è®¤å€¼ä¸º4096ï¼Œç¡®ä¿ä¸è¶…è¿‡APIé™åˆ¶
                maxTokensInput.value = 4096;
                updateCharCount();
            }
        }

        function savePageSettings() {
            const theme = document.getElementById('themeSelect').value;
            const fontSize = document.getElementById('fontSizeSelect').value;
            localStorage.setItem('ai_chat_settings', JSON.stringify({ theme, fontSize }));
            applySettings(theme, fontSize);
            closeModal(pageSettingsModal);
        }
        
        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('ai_chat_settings')) || { theme: 'auto', fontSize: 'medium' };
            document.getElementById('themeSelect').value = settings.theme;
            document.getElementById('fontSizeSelect').value = settings.fontSize;
            applySettings(settings.theme, settings.fontSize);
        }
        
        function applySettings(theme, fontSize) {
            const body = document.body;
            body.classList.remove('dark-mode');
            if (theme === 'dark' || (theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                body.classList.add('dark-mode');
            }
            document.documentElement.classList.remove('font-small', 'font-medium', 'font-large');
            document.documentElement.classList.add(`font-${fontSize}`);
        }

        function getCurrentConversation() {
            return conversations.find(c => c.id === currentConversationId);
        }

        function saveConversations() {
            try {
                localStorage.setItem('ai_conversations', JSON.stringify(conversations));
            } catch (e) {
                console.error("ä¿å­˜å¯¹è¯è®°å½•å¤±è´¥: ", e);
                // Optionally handle the error, e.g., by notifying the user
                // or trying to save a smaller subset of the data.
            }
        }

        function loadConversations() {
            const data = localStorage.getItem('ai_conversations');
            if (data) {
                try {
                    conversations = JSON.parse(data);
                    // Basic data migration/validation for older formats
                    conversations.forEach(conv => {
                        if (!conv.settings) {
                            conv.settings = JSON.parse(JSON.stringify(DEFAULT_SETTINGS));
                        }
                        if (!conv.createdAt) {
                            conv.createdAt = new Date().toISOString();
                        }
                        if (conv.messages) {
                            // æ¸…ç†å†å²ä¸­å¯èƒ½å­˜åœ¨çš„æ–‡ä»¶å‡†å¤‡æ¶ˆæ¯
                            conv.messages = conv.messages.filter(msg => 
                                !msg.content.includes('æ–‡ä»¶å·²å‡†å¤‡å°±ç»ª')
                            );
                            
                            conv.messages.forEach(msg => {
                                if (!msg.id) {
                                    msg.id = `${msg.role}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                                }
                            });
                        }
                        // ä¿®å¤é—®é¢˜3ï¼šç¡®ä¿æ–‡ä»¶ä¸Šä¸‹æ–‡å­—æ®µå­˜åœ¨
                        if (!conv.fileContext) {
                            conv.fileContext = null;
                        }
                    });
                } catch (e) {
                    console.error("åŠ è½½å¯¹è¯è®°å½•å¤±è´¥: ", e);
                    conversations = [];
                }
            } else {
                conversations = [];
            }
            updateConversationList();
        }
    </script>
</body>
</html>


